# é•¿éŸ³é¢‘å¤„ç†å™¨ (Long Audio Processor)

ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„é•¿éŸ³é¢‘å¤„ç†ç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºå¤„ç†é•¿éŸ³é¢‘æ–‡ä»¶çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…å«è¯´è¯äººåˆ†ç¦»ã€éŸ³é¢‘åˆ†å‰²å’Œè´¨é‡ç­›é€‰åŠŸèƒ½ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

### æ ¸å¿ƒåŠŸèƒ½
- **è¯´è¯äººåˆ†ç¦»**: ä½¿ç”¨ ten-vad + pyannote-audio è¿›è¡Œè¯´è¯äººèšç±»å’Œåˆ†ç¦»
- **éŸ³é¢‘åˆ†å‰²**: åŸºäºè¯´è¯äººä¿¡æ¯æ™ºèƒ½åˆ†å‰²éŸ³é¢‘ç‰‡æ®µ
- **è´¨é‡ç­›é€‰**: é›†æˆ Whisper + DNSMOS + DNSMOSPro + DistilMOS å¤šç»´åº¦è´¨é‡è¯„ä¼°
- **ç»“æ„åŒ–å­˜å‚¨**: æŒ‰ç…§ `é•¿éŸ³é¢‘id/è¯´è¯äººid/å¥å­id` çš„å±‚æ¬¡ç»“æ„å­˜å‚¨
- **å¤šGPUå¹¶è¡Œ**: æ”¯æŒå¤šGPUå¹¶è¡Œå¤„ç†ï¼Œå¤§å¹…æå‡å¤„ç†æ•ˆç‡

### æ”¹è¿›ç‰¹æ€§
- âœ… **ä¸¥æ ¼çš„GPUèµ„æºç®¡ç†**: æ¯GPUé™åˆ¶ä¸€ä¸ªè¿›ç¨‹ï¼Œé¿å…æ˜¾å­˜ç«äº‰
- âœ… **ä¸»åŠ¨æ˜¾å­˜ç®¡ç†**: å¤šå±‚æ¬¡æ˜¾å­˜æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- âœ… **æ™ºèƒ½é‡è¯•æœºåˆ¶**: æ¨¡å‹åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæ”¯æŒCPUåå¤‡æ¨¡å¼
- âœ… **å®æ—¶ç›‘æ§**: è¯¦ç»†çš„è¿›åº¦å’Œæ˜¾å­˜ä½¿ç”¨ç›‘æ§
- âœ… **æ‰¹é‡å¤„ç†ä¼˜åŒ–**: åˆ†æ‰¹å¤„ç†å‡å°‘æ˜¾å­˜å‹åŠ›

## ğŸ“‹ ç³»ç»Ÿæ¶æ„

```
é•¿éŸ³é¢‘æ–‡ä»¶ (.wav/.mp3/.flac/.m4a)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯´è¯äººåˆ†ç¦» (Speaker Diarization) â”‚
â”‚   â€¢ ten-vad è¯­éŸ³æ´»åŠ¨æ£€æµ‹            â”‚
â”‚   â€¢ pyannote-audio è¯´è¯äººèšç±»       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. éŸ³é¢‘åˆ†å‰² (Audio Segmentation)    â”‚
â”‚   â€¢ æŒ‰è¯´è¯äººç‰‡æ®µåˆ†å‰²                â”‚
â”‚   â€¢ ç”Ÿæˆç‹¬ç«‹éŸ³é¢‘æ–‡ä»¶                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è´¨é‡ç­›é€‰ (Quality Assessment)    â”‚
â”‚   â€¢ Whisper è¯­éŸ³è¯†åˆ«               â”‚
â”‚   â€¢ DNSMOS/DNSMOSPro è´¨é‡è¯„ä¼°      â”‚
â”‚   â€¢ DistilMOS æ„ŸçŸ¥è´¨é‡è¯„ä¼°         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç»“æ„åŒ–å­˜å‚¨                       â”‚
â”‚   è¾“å‡ºç›®å½•/éŸ³é¢‘ID/è¯´è¯äººID/ç‰‡æ®µ.wav â”‚
â”‚   + å®Œæ•´çš„å…ƒæ•°æ®ä¿¡æ¯ (.json)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ å®‰è£…é…ç½®

### ç¯å¢ƒè¦æ±‚
- Python 3.8+
- CUDA 11.0+ (GPUåŠ é€Ÿ)
- è‡³å°‘ 8GB GPUæ˜¾å­˜ (æ¨è16GB+)

### å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### ä¾èµ–è¯´æ˜
```txt
torch>=1.9.0
torchaudio>=0.9.0
transformers>=4.21.0
gin-config>=0.5.0
pyannote.audio>=2.1.1
soundfile>=0.10.3
librosa>=0.9.2
numpy>=1.21.0
```

### æ¨¡å‹å‡†å¤‡
1. **Whisperæ¨¡å‹**: è‡ªåŠ¨ä¸‹è½½åˆ° `/root/data/pretrained_models`
2. **Pyannoteæ¨¡å‹**: éœ€è¦ä»Hugging Faceè·å–è®¿é—®ä»¤ç‰Œ
3. **MOSè¯„ä¼°æ¨¡å‹**: è‡ªåŠ¨ä¸‹è½½ç›¸å…³è¯„ä¼°æ¨¡å‹

## ğŸ“ ç›®å½•ç»“æ„

```
long_speech_filter/
â”œâ”€â”€ __init__.py                    # æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ config.py                      # é…ç½®ç®¡ç†
â”œâ”€â”€ long_audio_processor.py        # å•è¿›ç¨‹ä¸»å¤„ç†å™¨
â”œâ”€â”€ multi_gpu_processor.py         # å¤šGPUå¹¶è¡Œå¤„ç†å™¨
â”œâ”€â”€ speaker_diarization.py         # è¯´è¯äººåˆ†ç¦»æ¨¡å—
â”œâ”€â”€ quality_filter.py             # è´¨é‡ç­›é€‰æ¨¡å—
â”œâ”€â”€ run_improved_multi_gpu.py      # å¯åŠ¨è„šæœ¬ (æ¨è)
â”œâ”€â”€ requirements.txt               # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md                      # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®å¤„ç† (è‡ªåŠ¨è·³è¿‡å·²å¤„ç†æ–‡ä»¶)
python run_improved_multi_gpu.py

# è‡ªå®šä¹‰è¾“å…¥è¾“å‡ºç›®å½•
python run_improved_multi_gpu.py \
    --input /path/to/input \
    --output /path/to/output
```

### 2. æ˜¾å­˜å—é™ç¯å¢ƒ
```bash
# ä¸¥æ ¼é™åˆ¶æ˜¾å­˜ä½¿ç”¨
python run_improved_multi_gpu.py \
    --memory-fraction 0.5 \
    --processes-per-gpu 1 \
    --max-concurrent 2
```

### 3. å¤„ç†æ¨¡å¼é€‰æ‹©
```bash
# é»˜è®¤æ¨¡å¼ï¼šè·³è¿‡å·²å¤„ç†æ–‡ä»¶ (æ¨è)
python run_improved_multi_gpu.py

# å¼ºåˆ¶é‡æ–°å¤„ç†æ‰€æœ‰æ–‡ä»¶
python run_improved_multi_gpu.py --force-reprocess

# å¤„ç†æ‰€æœ‰æ–‡ä»¶ä½†ä¸å¼ºåˆ¶é‡æ–°å¤„ç†å·²å­˜åœ¨çš„ç»“æœ
python run_improved_multi_gpu.py --no-skip-processed
```

### 4. æµ‹è¯•éªŒè¯
```bash
# å¹²è¿è¡Œæ£€æŸ¥é…ç½®
python run_improved_multi_gpu.py --dry-run

# æµ‹è¯•æ¨¡å¼å¤„ç†å°‘é‡æ–‡ä»¶
python run_improved_multi_gpu.py --test-mode
```

## âš™ï¸ é…ç½®å‚æ•°

### GPUé…ç½®
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--num-gpus` | -1 | ä½¿ç”¨GPUæ•°é‡ (-1è¡¨ç¤ºå…¨éƒ¨) |
| `--processes-per-gpu` | 1 | æ¯GPUæœ€å¤§è¿›ç¨‹æ•° |
| `--memory-fraction` | 0.6 | GPUæ˜¾å­˜ä½¿ç”¨æ¯”ä¾‹ |
| `--max-concurrent` | 4 | æœ€å¤§å¹¶å‘æ–‡ä»¶æ•° |

### æ¨¡å‹é…ç½®
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--whisper-model` | large-v3 | Whisperæ¨¡å‹åç§° |
| `--model-cache-dir` | /root/data/pretrained_models | æ¨¡å‹ç¼“å­˜ç›®å½• |

### è´¨é‡ç­›é€‰é˜ˆå€¼
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--min-words` | 1 | æœ€å°‘è¯æ•°è¦æ±‚ |
| `--distilmos-threshold` | 3.0 | DistilMOSé˜ˆå€¼ |
| `--dnsmos-threshold` | 3.0 | DNSMOSé˜ˆå€¼ |
| `--dnsmospro-threshold` | 3.0 | DNSMOSProé˜ˆå€¼ |

### å¤„ç†é€‰é¡¹
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--skip-processed` | True | è·³è¿‡å·²å¤„ç†çš„æ–‡ä»¶ (é»˜è®¤å¯ç”¨) |
| `--no-skip-processed` | False | å¤„ç†æ‰€æœ‰æ–‡ä»¶ï¼Œä¸è·³è¿‡å·²å¤„ç†çš„ |
| `--force-reprocess` | False | å¼ºåˆ¶é‡æ–°å¤„ç†æ‰€æœ‰æ–‡ä»¶ï¼Œå³ä½¿å·²å­˜åœ¨ç»“æœ |

## ğŸ”§ è¯¦ç»†å¤„ç†æµç¨‹

### ç¬¬ä¸€æ­¥: è¯´è¯äººåˆ†ç¦»

#### VAD (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)
```python
# ä½¿ç”¨ ten-vad æ£€æµ‹è¯­éŸ³ç‰‡æ®µ
vad_config = LongAudioVADConfig(
    threshold=0.5,              # æ£€æµ‹é˜ˆå€¼
    min_speech_duration=0.5,    # æœ€çŸ­è¯­éŸ³æ—¶é•¿
    max_speech_duration=30.0,   # æœ€é•¿è¯­éŸ³æ—¶é•¿
    min_silence_duration=0.1    # æœ€çŸ­é™éŸ³æ—¶é•¿
)
```

#### è¯´è¯äººèšç±»
```python
# ä½¿ç”¨ pyannote-audio è¿›è¡Œèšç±»
diarization_config = SpeakerDiarizationConfig(
    min_speakers=1,         # æœ€å°‘è¯´è¯äººæ•°
    max_speakers=10,        # æœ€å¤šè¯´è¯äººæ•°
    min_segment_duration=1.0, # æœ€çŸ­ç‰‡æ®µæ—¶é•¿
    use_local_models=True   # ä½¿ç”¨æœ¬åœ°æ¨¡å‹
)
```

#### è¾“å‡ºç»“æœ
- æ£€æµ‹åˆ°çš„è¯´è¯äººæ•°é‡
- æ¯ä¸ªè¯´è¯äººçš„æ—¶é—´ç‰‡æ®µ
- è¯­éŸ³æ´»åŠ¨æ€»æ—¶é•¿å’Œæ¯”ä¾‹

### ç¬¬äºŒæ­¥: éŸ³é¢‘åˆ†å‰²

#### ç‰‡æ®µæå–
- åŸºäºè¯´è¯äººæ—¶é—´æˆ³åˆ†å‰²éŸ³é¢‘
- ä¿æŒåŸå§‹é‡‡æ ·ç‡å’ŒéŸ³è´¨
- ç”Ÿæˆç‹¬ç«‹çš„éŸ³é¢‘ç‰‡æ®µ

#### å…ƒæ•°æ®è®°å½•
```json
{
    "segment_id": "1234567890_001",
    "speaker_id": "SPEAKER_00", 
    "start_time": 10.5,
    "end_time": 15.8,
    "duration": 5.3,
    "original_file": "audio.wav"
}
```

### ç¬¬ä¸‰æ­¥: è´¨é‡ç­›é€‰

#### Whisperè¯­éŸ³è¯†åˆ«
```python
# é…ç½®å‚æ•°
whisper_config = WhisperConfig(
    model_name="large-v3",      # æ¨¡å‹å¤§å°
    language=None,              # è‡ªåŠ¨æ£€æµ‹è¯­è¨€
    device="cuda",              # ä½¿ç”¨GPU
    batch_size=16               # æ‰¹å¤„ç†å¤§å°
)
```

**æ£€æŸ¥é¡¹ç›®:**
- æ˜¯å¦è¯†åˆ«åˆ°æ–‡å­—å†…å®¹
- è¯æ•°æ˜¯å¦æ»¡è¶³æœ€ä½è¦æ±‚
- è¯†åˆ«ç½®ä¿¡åº¦è¯„ä¼°

#### MOSè´¨é‡è¯„ä¼°
ä½¿ç”¨ä¸‰ç§äº’è¡¥çš„è´¨é‡è¯„ä¼°æ–¹æ³•:

1. **DNSMOS**: æ·±åº¦å™ªå£°æŠ‘åˆ¶è´¨é‡è¯„ä¼°
2. **DNSMOSPro**: å¢å¼ºç‰ˆDNSMOSï¼Œæ”¯æŒæ›´å¤šåœºæ™¯
3. **DistilMOS**: åŸºäºçŸ¥è¯†è’¸é¦çš„è½»é‡çº§è´¨é‡è¯„ä¼°

**è¯„ä¼°ç»´åº¦:**
- è¯­éŸ³æ¸…æ™°åº¦ (Speech Quality)
- èƒŒæ™¯å™ªå£° (Background Noise)
- æ•´ä½“æ„ŸçŸ¥è´¨é‡ (Overall Quality)

#### ç­›é€‰è§„åˆ™
```python
# è´¨é‡é˜ˆå€¼é…ç½®
quality_config = QualityFilterConfig(
    min_words=1,                    # æœ€å°‘è¯æ•°
    distil_mos_threshold=3.0,       # DistilMOS >= 3.0
    dnsmos_threshold=3.0,           # DNSMOS >= 3.0  
    dnsmospro_threshold=3.0,        # DNSMOSPro >= 3.0
    use_distil_mos=True,            # å¯ç”¨DistilMOS
    use_dnsmos=True,                # å¯ç”¨DNSMOS
    use_dnsmospro=True              # å¯ç”¨DNSMOSPro
)
```

### ç¬¬å››æ­¥: ç»“æ„åŒ–å­˜å‚¨

#### ç›®å½•ç»“æ„
```
è¾“å‡ºç›®å½•/
â””â”€â”€ éŸ³é¢‘ID_001/
    â”œâ”€â”€ SPEAKER_00/
    â”‚   â”œâ”€â”€ segment_1234567890_001.wav
    â”‚   â”œâ”€â”€ segment_1234567890_001.json
    â”‚   â”œâ”€â”€ segment_1234567890_002.wav
    â”‚   â””â”€â”€ segment_1234567890_002.json
    â”œâ”€â”€ SPEAKER_01/
    â”‚   â”œâ”€â”€ segment_1234567890_003.wav
    â”‚   â””â”€â”€ segment_1234567890_003.json
    â””â”€â”€ processing_summary.json
```

#### å…ƒæ•°æ®ä¿¡æ¯
æ¯ä¸ªéŸ³é¢‘ç‰‡æ®µå¯¹åº”ä¸€ä¸ªJSONæ–‡ä»¶ï¼ŒåŒ…å«:
```json
{
    "segment_id": "1234567890_001",
    "segment_counter": 1,
    "process_id": 12345,
    "timestamp": 1640995200000,
    "saved_path": "/path/to/segment.wav",
    "audio_id": "audio_001",
    "speaker_id": "SPEAKER_00",
    "original_metadata": {
        "start_time": 10.5,
        "end_time": 15.8,
        "duration": 5.3
    },
    "transcription": {
        "text": "è¿™æ˜¯è¯†åˆ«çš„æ–‡å­—å†…å®¹",
        "language": "zh",
        "word_count": 8,
        "confidence": 0.95
    },
    "quality_scores": {
        "distilmos": 3.8,
        "dnsmos_ovrl": 3.5,
        "dnsmos_sig": 3.7,
        "dnsmos_bak": 4.1,
        "dnsmospro": 3.6
    },
    "evaluation_passed": true,
    "processing_timestamp": "2023-12-31T23:59:59"
}
```

## ğŸ” æ˜¾å­˜ç®¡ç†ä¼˜åŒ–

### é—®é¢˜èƒŒæ™¯
åŸç³»ç»Ÿå­˜åœ¨ä¸¥é‡çš„æ˜¾å­˜ç®¡ç†é—®é¢˜:
- å¤šä¸ªè¿›ç¨‹ç«äº‰åŒä¸€GPUï¼Œæ€»æ˜¾å­˜å ç”¨è¶…è¿‡å•å¡å®¹é‡
- æ¨¡å‹åŠ è½½åæ˜¾å­˜æœªé‡Šæ”¾ï¼Œå¯¼è‡´æ˜¾å­˜æ³„æ¼
- ç¼ºå°‘æ˜¾å­˜ç›‘æ§ï¼Œæ— æ³•åŠæ—¶å‘ç°é—®é¢˜

### è§£å†³æ–¹æ¡ˆ

#### 1. ä¸¥æ ¼GPUè¿›ç¨‹ç®¡ç†
```python
class SimpleGPUManager:
    """æ”¹è¿›çš„GPUèµ„æºç®¡ç†å™¨"""
    
    def acquire_gpu(self, process_id: int) -> Optional[int]:
        """ä¸¥æ ¼é™åˆ¶æ¯GPUè¿›ç¨‹æ•°"""
        if data['process_count'] < data['max_processes']:
            data['process_count'] += 1
            data['current_processes'].append({
                'process_id': process_id,
                'start_time': time.time()
            })
            return gpu_id
```

#### 2. å¤šå±‚æ¬¡æ˜¾å­˜æ¸…ç†
```python
def cleanup_gpu_memory():
    """åŸºç¡€æ˜¾å­˜æ¸…ç†"""
    torch.cuda.empty_cache()
    gc.collect()
    torch.cuda.empty_cache()

def _aggressive_memory_cleanup(self):
    """æ¿€è¿›æ˜¾å­˜æ¸…ç†"""
    for i in range(3):
        gc.collect()
        torch.cuda.empty_cache()
        torch.cuda.synchronize()
```

#### 3. å®æ—¶æ˜¾å­˜ç›‘æ§
```python
def get_gpu_memory_usage(gpu_id: int) -> float:
    """è·å–GPUæ˜¾å­˜ä½¿ç”¨ç‡"""
    allocated = torch.cuda.memory_allocated(gpu_id)
    total = torch.cuda.get_device_properties(gpu_id).total_memory
    return allocated / total
```

#### 4. æ™ºèƒ½é‡è¯•æœºåˆ¶
- CUDA OOMæ—¶è‡ªåŠ¨æ¸…ç†æ˜¾å­˜å¹¶é‡è¯•
- å¤šæ¬¡å¤±è´¥åå¯ç”¨CPUåå¤‡æ¨¡å¼
- æ¨¡å‹åˆå§‹åŒ–å¤±è´¥æ—¶çš„æ¸è¿›å¼é™çº§

#### 5. æ‰¹é‡å¤„ç†ä¼˜åŒ–
- å°æ‰¹é‡å¤„ç† (5ä¸ªæ–‡ä»¶/æ‰¹)
- æ‰¹æ¬¡å†…å®šæœŸæ¸…ç† (æ¯3ä¸ªæ–‡ä»¶)
- æ‰¹æ¬¡é—´ä¼‘æ¯ï¼Œé˜²æ­¢æ˜¾å­˜ç§¯ç´¯

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å®æ—¶ç›‘æ§
ç³»ç»Ÿæ¯15ç§’è¾“å‡ºè¿›åº¦ä¿¡æ¯:
```log
å¤„ç†è¿›åº¦: 45/100 (45.0%) - å·²ç”¨æ—¶: 12.3åˆ†é’Ÿ, é¢„è®¡å‰©ä½™: 15.2åˆ†é’Ÿ
GPUçŠ¶æ€: 4/8 ä¸ªGPUæ´»è·ƒ, æ€»è¿›ç¨‹æ•°: 4
  GPU 0: 1 è¿›ç¨‹, æ˜¾å­˜: 67.2%
  GPU 1: 1 è¿›ç¨‹, æ˜¾å­˜: 63.8%
  GPU 2: 1 è¿›ç¨‹, æ˜¾å­˜: 71.5%
  GPU 3: 1 è¿›ç¨‹, æ˜¾å­˜: 59.3%
```

### è¯¦ç»†æ—¥å¿—
```log
2025-01-31 17:08:22 - è¿›ç¨‹ 12345 è·å–åˆ° GPU 0 (è¿›ç¨‹æ•°: 1/1)
2025-01-31 17:08:23 - GPU 0 åˆå§‹æ˜¾å­˜ä½¿ç”¨ç‡: 15.2%
2025-01-31 17:08:45 - GPU 0 æ¨¡å‹åŠ è½½åæ˜¾å­˜ä½¿ç”¨ç‡: 45.8%
2025-01-31 17:09:12 - GPU 0 å¤„ç†å®Œæˆåæ˜¾å­˜ä½¿ç”¨ç‡: 47.1%
2025-01-31 17:09:13 - GPU 0 æ¸…ç†åæ˜¾å­˜ä½¿ç”¨ç‡: 15.5%
2025-01-31 17:09:13 - è¿›ç¨‹ 12345 é‡Šæ”¾ GPU 0 (å‰©ä½™è¿›ç¨‹æ•°: 0)
```

### æœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š
```log
=== å¤„ç†å®Œæˆ ===
ğŸ“Š æ€»æ–‡ä»¶æ•°: 100
âœ… æˆåŠŸå¤„ç†: 95
âŒ å¤±è´¥æ–‡ä»¶: 5
ğŸ“ˆ æˆåŠŸç‡: 95.0%
â±ï¸ æ€»å¤„ç†æ—¶é—´: 45.6åˆ†é’Ÿ
âš¡ å¹³å‡å¤„ç†æ—¶é—´: 27.4ç§’/æ–‡ä»¶

ğŸ–¥ï¸ GPUä½¿ç”¨ç»Ÿè®¡:
   GPU 0: å¤„ç†äº† 24 ä¸ªæ–‡ä»¶, æœ€ç»ˆæ˜¾å­˜: 16.2%
   GPU 1: å¤„ç†äº† 25 ä¸ªæ–‡ä»¶, æœ€ç»ˆæ˜¾å­˜: 14.8%
   GPU 2: å¤„ç†äº† 23 ä¸ªæ–‡ä»¶, æœ€ç»ˆæ˜¾å­˜: 18.1%
   GPU 3: å¤„ç†äº† 23 ä¸ªæ–‡ä»¶, æœ€ç»ˆæ˜¾å­˜: 15.9%

ğŸ“Š æ˜¾å­˜ä½¿ç”¨ç»Ÿè®¡:
   GPU 0: å³°å€¼ 72.3%, å¹³å‡ 58.7%
   GPU 1: å³°å€¼ 69.8%, å¹³å‡ 56.2%
   GPU 2: å³°å€¼ 75.1%, å¹³å‡ 61.4%
   GPU 3: å³°å€¼ 68.9%, å¹³å‡ 57.8%
```

## ğŸ”§ æ•…éšœæ’é™¤

### 1. CUDAå†…å­˜ä¸è¶³
**ç—‡çŠ¶**: `CUDA out of memory` é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**:
```bash
# é™ä½æ˜¾å­˜ä½¿ç”¨æ¯”ä¾‹
python run_improved_multi_gpu.py --memory-fraction 0.4

# å‡å°‘å¹¶å‘è¿›ç¨‹æ•°
python run_improved_multi_gpu.py --processes-per-gpu 1 --max-concurrent 2

# ä½¿ç”¨æ›´å°çš„Whisperæ¨¡å‹
python run_improved_multi_gpu.py --whisper-model medium
```

### 2. å¤„ç†é€Ÿåº¦è¿‡æ…¢
**ç—‡çŠ¶**: GPUåˆ©ç”¨ç‡ä½ï¼Œå¤„ç†é€Ÿåº¦æ…¢
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥GPUçŠ¶æ€
python run_improved_multi_gpu.py --dry-run

# é€‚å½“å¢åŠ å¹¶å‘ï¼ˆç¡®ä¿æ˜¾å­˜å……è¶³ï¼‰
python run_improved_multi_gpu.py --max-concurrent 6
```

### 3. è¿›ç¨‹æŒ‚èµ·
**ç—‡çŠ¶**: å¤„ç†è¿›åº¦åœæ»ï¼Œè¿›ç¨‹æ— å“åº”
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥GPUé”æ–‡ä»¶
ls gpu_work/session_*/gpu_*.lock

# æ¸…ç†å¼‚å¸¸é”æ–‡ä»¶
rm -rf gpu_work/

# é‡æ–°å¯åŠ¨å¤„ç†
python run_improved_multi_gpu.py
```

### 4. è´¨é‡ç­›é€‰é€šè¿‡ç‡è¿‡ä½
**ç—‡çŠ¶**: å¤§éƒ¨åˆ†éŸ³é¢‘ç‰‡æ®µè¢«ç­›é€‰æ‰
**è§£å†³æ–¹æ¡ˆ**:
```bash
# é™ä½è´¨é‡é˜ˆå€¼
python run_improved_multi_gpu.py \
    --distilmos-threshold 2.5 \
    --dnsmos-threshold 2.5 \
    --dnsmospro-threshold 2.5

# å‡å°‘è¯æ•°è¦æ±‚
python run_improved_multi_gpu.py --min-words 1
```

### 5. è·³è¿‡å·²å¤„ç†æ–‡ä»¶ç›¸å…³é—®é¢˜
**ç—‡çŠ¶**: æ–‡ä»¶è¢«é”™è¯¯è·³è¿‡æˆ–é‡å¤å¤„ç†
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹å¤„ç†çŠ¶æ€
ls output_dir/audio_id/processing_summary.json

# å¼ºåˆ¶é‡æ–°å¤„ç†ç‰¹å®šæ–‡ä»¶
python run_improved_multi_gpu.py --force-reprocess

# åˆ é™¤éƒ¨åˆ†å¤„ç†ç»“æœé‡æ–°å¤„ç†
rm -rf output_dir/audio_id && python run_improved_multi_gpu.py
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç¡¬ä»¶é…ç½®
- **GPU**: æ¨èRTX 3090/4090æˆ–V100ï¼Œè‡³å°‘16GBæ˜¾å­˜
- **CPU**: æ¨è16æ ¸å¿ƒä»¥ä¸Šï¼Œæ”¯æŒé«˜å¹¶å‘I/O
- **å†…å­˜**: æ¨è64GBä»¥ä¸Šï¼Œæ”¯æŒå¤§é‡éŸ³é¢‘æ–‡ä»¶ç¼“å­˜
- **å­˜å‚¨**: æ¨èNVMe SSDï¼Œæé«˜éŸ³é¢‘è¯»å†™é€Ÿåº¦

### å‚æ•°è°ƒä¼˜
| åœºæ™¯ | memory-fraction | processes-per-gpu | max-concurrent |
|------|----------------|-------------------|----------------|
| æ˜¾å­˜å……è¶³ (24GB+) | 0.7 | 1 | 8 |
| æ˜¾å­˜ä¸€èˆ¬ (16GB) | 0.6 | 1 | 4 |
| æ˜¾å­˜å—é™ (8GB) | 0.5 | 1 | 2 |
| æé™æƒ…å†µ (4GB) | 0.4 | 1 | 1 |

### æ‰¹å¤„ç†ç­–ç•¥
- æŒ‰éŸ³é¢‘æ–‡ä»¶å¤§å°åˆ†ç»„å¤„ç†
- ä¼˜å…ˆå¤„ç†çŸ­éŸ³é¢‘ï¼Œé¿å…é•¿éŸ³é¢‘é˜»å¡
- åˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°ï¼Œå¹³è¡¡æ•ˆç‡å’Œç¨³å®šæ€§
- åˆ©ç”¨è·³è¿‡å·²å¤„ç†æ–‡ä»¶åŠŸèƒ½å®ç°æ–­ç‚¹ç»­ä¼ 

## ğŸ’¡ è·³è¿‡å·²å¤„ç†æ–‡ä»¶åŠŸèƒ½è¯¦è§£

### å·¥ä½œåŸç†
ç³»ç»Ÿé€šè¿‡æ£€æŸ¥è¾“å‡ºç›®å½•ä¸­çš„ `processing_summary.json` æ–‡ä»¶æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²è¢«å¤„ç†ï¼š

1. **æ£€æŸ¥è·¯å¾„**: `output_dir/audio_id/processing_summary.json`
2. **åˆ¤æ–­æ ‡å‡†**: 
   - æ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»å–
   - `success` å­—æ®µä¸º `true`
   - `processing_results.passed_segments` > 0

### ä½¿ç”¨åœºæ™¯

#### åœºæ™¯1: æ­£å¸¸å¤„ç†ï¼ˆé»˜è®¤ï¼‰
```bash
# è‡ªåŠ¨è·³è¿‡å·²å¤„ç†æ–‡ä»¶ï¼Œåªå¤„ç†æ–°æ–‡ä»¶
python run_improved_multi_gpu.py
```

#### åœºæ™¯2: ä¸­æ–­åæ¢å¤
```bash
# å¤„ç†è¿‡ç¨‹ä¸­æ–­åé‡æ–°è¿è¡Œï¼Œä¼šè‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„æ–‡ä»¶
python run_improved_multi_gpu.py
```

#### åœºæ™¯3: å¼ºåˆ¶é‡æ–°å¤„ç†
```bash
# é‡æ–°å¤„ç†æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬å·²å¤„ç†çš„
python run_improved_multi_gpu.py --force-reprocess
```

#### åœºæ™¯4: è´¨é‡è¦æ±‚å˜æ›´
```bash
# ä¿®æ”¹è´¨é‡é˜ˆå€¼åï¼Œå¼ºåˆ¶é‡æ–°å¤„ç†
python run_improved_multi_gpu.py \
    --force-reprocess \
    --distilmos-threshold 3.5
```

### ä¼˜åŠ¿
- âœ… **æ–­ç‚¹ç»­ä¼ **: ä¸­æ–­åå¯ç»§ç»­å¤„ç†æœªå®Œæˆçš„æ–‡ä»¶
- âœ… **é¿å…é‡å¤**: èŠ‚çœå¤§é‡è®¡ç®—æ—¶é—´å’Œèµ„æº
- âœ… **çµæ´»æ§åˆ¶**: æ”¯æŒå¤šç§å¤„ç†æ¨¡å¼
- âœ… **çŠ¶æ€é€æ˜**: æ¸…æ™°æ˜¾ç¤ºè·³è¿‡å’Œå¤„ç†çš„æ–‡ä»¶æ•°é‡

## ğŸ¤ å¼€å‘è€…æŒ‡å—

### æ¨¡å—æ‰©å±•
å¯ä»¥é€šè¿‡ç»§æ‰¿åŸºç±»æ¥æ‰©å±•åŠŸèƒ½:
```python
from long_audio_processor import LongAudioProcessor

class CustomAudioProcessor(LongAudioProcessor):
    def custom_preprocessing(self, audio_path):
        # è‡ªå®šä¹‰é¢„å¤„ç†é€»è¾‘
        pass
    
    def custom_postprocessing(self, result):
        # è‡ªå®šä¹‰åå¤„ç†é€»è¾‘
        pass
```

### æ–°å¢è´¨é‡è¯„ä¼°å™¨
```python
from quality_filter import LongAudioQualityFilter

class CustomQualityFilter(LongAudioQualityFilter):
    def custom_quality_assessment(self, audio_path):
        # å®ç°è‡ªå®šä¹‰è´¨é‡è¯„ä¼°
        pass
```

### é…ç½®è‡ªå®šä¹‰
æ‰€æœ‰é…ç½®éƒ½å¯ä»¥é€šè¿‡ä¿®æ”¹ `config.py` æ¥å®šåˆ¶:
```python
@dataclass
class CustomConfig(LongAudioProcessingConfig):
    # æ·»åŠ è‡ªå®šä¹‰é…ç½®é¡¹
    custom_param: str = "default_value"
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦æƒ…è¯·å‚é˜… LICENSE æ–‡ä»¶ã€‚

## ğŸ™ è‡´è°¢

- [OpenAI Whisper](https://github.com/openai/whisper) - è¯­éŸ³è¯†åˆ«
- [pyannote-audio](https://github.com/pyannote/pyannote-audio) - è¯´è¯äººåˆ†ç¦»
- [DNSMOS](https://github.com/microsoft/DNS-Challenge) - è¯­éŸ³è´¨é‡è¯„ä¼°
- [PyTorch](https://pytorch.org/) - æ·±åº¦å­¦ä¹ æ¡†æ¶

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·:
1. æŸ¥çœ‹æœ¬READMEçš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
3. ä½¿ç”¨ `--dry-run` æ¨¡å¼éªŒè¯é…ç½®
4. å°è¯• `--test-mode` è¿›è¡Œå°è§„æ¨¡æµ‹è¯•

---

**æ³¨**: æœ¬ç³»ç»Ÿé’ˆå¯¹é•¿éŸ³é¢‘å¤„ç†è¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯åœ¨æ˜¾å­˜ç®¡ç†å’Œå¤šGPUå¹¶è¡Œå¤„ç†æ–¹é¢ã€‚å»ºè®®åœ¨æ­£å¼ä½¿ç”¨å‰å…ˆè¿›è¡Œå°è§„æ¨¡æµ‹è¯•ï¼Œç¡®è®¤é…ç½®å‚æ•°é€‚åˆæ‚¨çš„ç¡¬ä»¶ç¯å¢ƒã€‚