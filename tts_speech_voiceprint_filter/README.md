# TTS å¤åˆ»éŸ³é¢‘å£°çº¹ç›¸ä¼¼åº¦ç­›é€‰å·¥å…·

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬å·¥å…·ç”¨äºå¯¹ TTSï¼ˆText-to-Speechï¼‰è¯­éŸ³å¤åˆ»ç³»ç»Ÿäº§å‡ºçš„åˆæˆéŸ³é¢‘è¿›è¡Œè´¨é‡è¯„ä¼°å’Œç­›é€‰ã€‚é€šè¿‡è®¡ç®—"åŸå§‹æç¤ºéŸ³é¢‘"ä¸"TTS å¤åˆ»éŸ³é¢‘"ä¹‹é—´çš„å£°çº¹ç›¸ä¼¼åº¦ï¼Œè‡ªåŠ¨ç­›é™¤ç›¸ä¼¼åº¦ä½äºé˜ˆå€¼çš„æ ·æœ¬ï¼Œç¡®ä¿æœ€ç»ˆæ•°æ®é›†çš„å£°çº¹ä¸€è‡´æ€§å’Œè´¨é‡ã€‚

### æ ¸å¿ƒåŠŸèƒ½

- **å£°çº¹ç›¸ä¼¼åº¦è®¡ç®—**ï¼šåŸºäº WeSpeaker æ¨¡å‹ï¼ˆsamresnet100ï¼‰æå–éŸ³é¢‘çš„è¯´è¯äººç‰¹å¾ï¼ˆembeddingsï¼‰ï¼Œè®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
- **æ™ºèƒ½ VAD å¤„ç†**ï¼šä½¿ç”¨ TEN VADï¼ˆå¯é€‰ï¼‰å¯¹éŸ³é¢‘è¿›è¡Œè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼Œä»…åœ¨æœ‰æ•ˆè¯­éŸ³ç‰‡æ®µä¸Šè®¡ç®—ç›¸ä¼¼åº¦ï¼Œæé«˜å‡†ç¡®æ€§
- **å¤š GPU å¹¶è¡Œ**ï¼šæ”¯æŒå¤š GPU åˆ†ç‰‡å¤„ç†ï¼Œæ˜¾è‘—æå‡å¤§è§„æ¨¡æ•°æ®çš„å¤„ç†æ•ˆç‡
- **çµæ´»çš„æ•°æ®åŒ¹é…**ï¼šæ”¯æŒå¤šç§æ˜ å°„æ ¼å¼ï¼ˆJSONï¼‰ï¼Œè‡ªåŠ¨ä» Kaldi wav.scp ä¸­æŸ¥æ‰¾åŸå§‹éŸ³é¢‘
- **è°ƒè¯•æ¨¡å¼**ï¼šå¯éšæœºé‡‡æ ·å°‘é‡æ•°æ®è¿›è¡Œæµ‹è¯•ï¼Œå¹¶ä¿å­˜ VAD å¯è§†åŒ–å›¾åƒä¾¿äºåˆ†æ

---

## ğŸ—ï¸ æ•´ä½“æµç¨‹

### å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜ å°„ JSON æ–‡ä»¶  â”‚ (åŒ…å« voiceprint_id, prompt_id ç­‰ä¿¡æ¯)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸå§‹éŸ³é¢‘ç´¢å¼•     â”‚                â”‚ TTS å¤åˆ»éŸ³é¢‘     â”‚
â”‚ (wav.scp)       â”‚                â”‚ (zero_shot ç›®å½•) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ é…å¯¹æ„å»º (Pairs)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   VAD é¢„å¤„ç†     â”‚ (å¯é€‰ï¼šTEN VAD)
              â”‚ (æå–æœ‰æ•ˆè¯­éŸ³)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ å£°çº¹ç‰¹å¾æå–      â”‚ (WeSpeaker)
              â”‚ (Embeddings)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   é˜ˆå€¼ç­›é€‰       â”‚ (similarity >= threshold)
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»“æœ JSON       â”‚          â”‚ ç­›é™¤åˆ—è¡¨ TXT    â”‚
â”‚ (è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯)  â”‚          â”‚ (ä¸é€šè¿‡çš„æ–‡ä»¶)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµç¨‹è¯´æ˜

1. **æ•°æ®å‡†å¤‡é˜¶æ®µ**
   - è¯»å–æ˜ å°„ JSON æ–‡ä»¶ï¼Œè·å– voiceprint_idã€prompt_idã€source_utt ç­‰ä¿¡æ¯
   - ä» Kaldi æ ¼å¼çš„ wav.scp æ–‡ä»¶ä¸­æ„å»ºåŸå§‹éŸ³é¢‘ç´¢å¼•ï¼ˆæ”¯æŒå¤šçº§ç´¢å¼•ï¼šutt_idã€basenameã€stemï¼‰
   - æ ¹æ®çº¦å®šè·¯å¾„æŸ¥æ‰¾ TTS å¤åˆ»éŸ³é¢‘ï¼ˆé€šå¸¸åœ¨ `<zero_shot>/<prompt_id>/<voiceprint_id>.wav`ï¼‰

2. **é…å¯¹åŒ¹é…é˜¶æ®µ**
   - å¯¹æ¯æ¡æ˜ å°„è®°å½•ï¼Œå°è¯•åŒ¹é…åŸå§‹éŸ³é¢‘ä¸ TTS éŸ³é¢‘
   - ä¼˜å…ˆä½¿ç”¨æ˜¾å¼æä¾›çš„è·¯å¾„ï¼ˆsource_pathï¼‰
   - è‹¥æ— æ˜¾å¼è·¯å¾„ï¼Œåˆ™æŒ‰ source_utt æˆ– prompt_id åœ¨ wav.scp ç´¢å¼•ä¸­ç²¾ç¡®æŸ¥æ‰¾
   - ä»…ä¿ç•™èƒ½æˆåŠŸæ‰¾åˆ°ä¸¤ç«¯éŸ³é¢‘æ–‡ä»¶çš„é…å¯¹

3. **éŸ³é¢‘é¢„å¤„ç†é˜¶æ®µ**
   - å°†éŸ³é¢‘é‡é‡‡æ ·è‡³ 16kHzï¼ˆWeSpeaker æ¨¡å‹è¦æ±‚ï¼‰
   - å¦‚æœå¯ç”¨ TEN VADï¼Œåˆ™æ£€æµ‹è¯­éŸ³æ´»åŠ¨åŒºé—´ï¼Œæå–æœ‰æ•ˆè¯­éŸ³ç‰‡æ®µ
   - å¦‚æœæœ‰æ•ˆè¯­éŸ³è¿‡çŸ­ï¼ˆ<200msï¼‰ï¼Œåˆ™å›é€€ä½¿ç”¨å®Œæ•´éŸ³é¢‘

4. **ç›¸ä¼¼åº¦è®¡ç®—é˜¶æ®µ**
   - ä½¿ç”¨ WeSpeaker æ¨¡å‹æå– embeddingsï¼ˆè¯´è¯äººç‰¹å¾å‘é‡ï¼‰
   - è®¡ç®—ä¸¤ä¸ªéŸ³é¢‘ embeddings ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦
   - æ”¯æŒå• GPU çº¿ç¨‹æ± å¹¶å‘æˆ–å¤š GPU å¤šè¿›ç¨‹å¹¶è¡Œ

5. **ç»“æœè¾“å‡ºé˜¶æ®µ**
   - ç»Ÿè®¡ç›¸ä¼¼åº¦åˆ†å¸ƒï¼ˆå‡å€¼ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®ç­‰ï¼‰
   - æ ¹æ®é˜ˆå€¼å°†æ ·æœ¬åˆ†ä¸º"é€šè¿‡"å’Œ"ç­›é™¤"ä¸¤ç±»
   - ç”Ÿæˆè¯¦ç»†ç»“æœ JSON å’Œç­›é™¤åˆ—è¡¨ TXT æ–‡ä»¶

---

## ğŸ“ æ–‡ä»¶ç»“æ„ä¸è¯´æ˜

### æ ¸å¿ƒè„šæœ¬

#### 1. `run_voiceprint_filter.sh` - Shell å¯åŠ¨è„šæœ¬

**åŠŸèƒ½ï¼š** æ•´ä¸ªæµç¨‹çš„å…¥å£è„šæœ¬ï¼Œè´Ÿè´£å‚æ•°è§£æã€ç¯å¢ƒå‡†å¤‡ã€Python è„šæœ¬è°ƒç”¨

**ä¸»è¦èŒè´£ï¼š**
- è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ˆæ˜ å°„ç›®å½•ã€TTS è·¯å¾„ã€é˜ˆå€¼ã€GPU æ•°é‡ç­‰ï¼‰
- è¯»å– config.json ä¸­çš„é»˜è®¤é…ç½®
- æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œåˆ›å»ºè¾“å‡ºç›®å½•
- æ¿€æ´» conda ç¯å¢ƒï¼ˆSpeakerIdentifyï¼‰
- æ„å»ºå¹¶æ‰§è¡Œ Python å‘½ä»¤

**å…³é”®å‚æ•°ï¼š**
```bash
--mapping_dir DIR         # æ˜ å°„ JSON æ–‡ä»¶æ‰€åœ¨ç›®å½•
--tts_zero_shot DIR       # TTS å¤åˆ»éŸ³é¢‘çš„ zero_shot æ ¹ç›®å½•
--wav_scp PATH            # Kaldi wav.scp æ–‡ä»¶è·¯å¾„ï¼ˆå¯å¤šæ¬¡ä¼ å…¥ï¼‰
--threshold FLOAT         # ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤ 0.70ï¼‰
--model_dir DIR           # WeSpeaker æ¨¡å‹ç›®å½•ï¼ˆsamresnet100ï¼‰
--num_gpus INT            # ä½¿ç”¨çš„ GPU æ•°é‡ï¼ˆé»˜è®¤ 4ï¼‰
--num_workers INT         # å• GPU æ—¶çš„çº¿ç¨‹æ•°ï¼ˆé»˜è®¤ 4ï¼‰
--output PATH             # è¾“å‡º JSON è·¯å¾„
--debug                   # å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆéšæœºé‡‡æ ·ï¼Œä¿å­˜ VAD å›¾ï¼‰
--debug_samples INT       # è°ƒè¯•æ¨¡å¼é‡‡æ ·æ•°ï¼ˆé»˜è®¤ 100ï¼‰
--debug_dir DIR           # è°ƒè¯•è¾“å‡ºç›®å½•
--verbose                 # è¯¦ç»†æ—¥å¿—
```

**ä»£ç é€»è¾‘ï¼š**
1. å®šä¹‰é»˜è®¤é…ç½®ï¼ˆå¯ä» config.json è¯»å–ï¼‰
2. è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå‚æ•°ä¼˜å…ˆçº§é«˜äºé»˜è®¤å€¼
3. æ£€æŸ¥å¿…éœ€çš„ç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
4. æ¿€æ´» SpeakerIdentify conda ç¯å¢ƒ
5. æ„å»º Python å‘½ä»¤å­—ç¬¦ä¸²å¹¶æ‰§è¡Œ
6. æ£€æŸ¥è¿”å›ç ï¼Œè¾“å‡ºæˆåŠŸæˆ–å¤±è´¥ä¿¡æ¯

---

#### 2. `compute_similarity.py` - æ ¸å¿ƒè®¡ç®—è„šæœ¬

**åŠŸèƒ½ï¼š** æ‰§è¡Œæ‰€æœ‰æ ¸å¿ƒé€»è¾‘ï¼ŒåŒ…æ‹¬æ•°æ®åŠ è½½ã€é…å¯¹æ„å»ºã€ç›¸ä¼¼åº¦è®¡ç®—ã€ç»“æœä¿å­˜

**ä¸»è¦æ¨¡å—ï¼š**

##### 2.1 æ•°æ®åŠ è½½ä¸ç´¢å¼•æ„å»º
```python
def read_wav_scp(paths: List[str]) -> Tuple[Dict, Dict, Dict]
```
- **åŠŸèƒ½ï¼š** è¯»å–ä¸€ä¸ªæˆ–å¤šä¸ª Kaldi wav.scp æ–‡ä»¶ï¼Œæ„å»ºä¸‰ç§ç´¢å¼•ç»“æ„
- **è¿”å›å€¼ï¼š**
  - `by_id`: `{utt_id -> éŸ³é¢‘ç»å¯¹è·¯å¾„}` - ç²¾ç¡® ID åŒ¹é…
  - `by_basename`: `{æ–‡ä»¶å…¨å -> [è·¯å¾„åˆ—è¡¨]}` - æŒ‰æ–‡ä»¶ååŒ¹é…
  - `by_stem`: `{æ— æ‰©å±•åæ–‡ä»¶å -> [è·¯å¾„åˆ—è¡¨]}` - æŒ‰ stem åŒ¹é…
- **ç”¨é€”ï¼š** æ”¯æŒå¤šç§åŒ¹é…ç­–ç•¥ï¼Œæé«˜åŸå§‹éŸ³é¢‘çš„æŸ¥æ‰¾æˆåŠŸç‡

##### 2.2 éŸ³é¢‘è·¯å¾„æŸ¥æ‰¾
```python
def exact_find_source_wav_by_utt(utt_id: str, wav_index_by_id: Dict) -> Optional[str]
```
- **åŠŸèƒ½ï¼š** ä¸¥æ ¼æŒ‰ utt_id åœ¨ç´¢å¼•ä¸­ç²¾ç¡®æŸ¥æ‰¾åŸå§‹éŸ³é¢‘è·¯å¾„
- **ç‰¹ç‚¹ï¼š** ä¸åšä»»ä½•æ¨¡ç³ŠåŒ¹é…ï¼Œé¿å…è¯¯åŒ¹é…

```python
def find_source_wav(voiceprint_id: str, hint_utt: Optional[str], 
                   hint_path: Optional[str], ...) -> Optional[str]
```
- **åŠŸèƒ½ï¼š** ç»¼åˆå¤šç§çº¿ç´¢æŸ¥æ‰¾æºéŸ³é¢‘ï¼ŒæŒ‰ä¼˜å…ˆçº§å°è¯•
- **ä¼˜å…ˆçº§ï¼š**
  1. æ˜¾å¼æä¾›çš„ source_path
  2. æ˜¾å¼æä¾›çš„ source_uttï¼ˆåœ¨ wav.scp ä¸­ç²¾ç¡®åŒ¹é…ï¼‰
  3. voiceprint_id çš„ stem ç²¾ç¡®åŒ¹é…
  4. voiceprint_id çš„åŒ…å«å…³ç³»æ¨¡ç³ŠåŒ¹é…ï¼ˆå¯èƒ½æœ‰æ­§ä¹‰ï¼Œä»…å–ç¬¬ä¸€ä¸ªï¼‰

##### 2.3 é…å¯¹æ„å»º
```python
def build_pairs_from_mapping(mapping_dir: str, tts_zero_shot: str, 
                            wav_scp_paths: List[str], ...) -> List[Tuple]
```
- **åŠŸèƒ½ï¼š** ä»æ˜ å°„ JSON ç›®å½•æ„å»º `(æºéŸ³é¢‘, TTSéŸ³é¢‘, voiceprint_id, prompt_id)` å››å…ƒç»„åˆ—è¡¨
- **å¤„ç†é€»è¾‘ï¼š**
  1. éå†æ˜ å°„ç›®å½•ä¸‹æ‰€æœ‰ `.json` æ–‡ä»¶
  2. è§£æ JSON ç»“æ„ï¼ˆæ”¯æŒå¯¹è±¡å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼ï¼‰
  3. å¯¹æ¯ä¸ªæ¡ç›®ï¼š
     - æå– voiceprint_idã€source_uttã€source_path ç­‰å­—æ®µ
     - è‹¥æœªæ˜¾å¼æä¾› TTS è·¯å¾„ï¼ŒæŒ‰çº¦å®šæ‹¼æ¥ï¼š`<zero_shot>/<prompt_id>/<voiceprint_id>.wav`
     - ä½¿ç”¨ `exact_find_source_wav_by_utt` ç²¾ç¡®æŸ¥æ‰¾åŸå§‹éŸ³é¢‘ï¼ˆé»˜è®¤ä½¿ç”¨ prompt_id ä½œä¸º utt_idï¼‰
     - æ£€æŸ¥ä¸¤ç«¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  4. åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œæ”¯æŒéšæœºæ‰“ä¹±å¹¶é™åˆ¶é‡‡æ ·æ•°é‡
- **è¾“å‡ºï¼š** æœ‰æ•ˆé…å¯¹åˆ—è¡¨

##### 2.4 VAD å¤„ç†
```python
def _apply_ten_vad_refined(audio: np.ndarray, sr: int, ...) -> np.ndarray
```
- **åŠŸèƒ½ï¼š** ä½¿ç”¨ TEN VAD æ£€æµ‹è¯­éŸ³æ´»åŠ¨åŒºé—´ï¼Œè¿”å›æ ·æœ¬çº§æ©ç ï¼ˆmaskï¼‰
- **å‚æ•°ï¼š**
  - `frame_ms`: VAD å¸§é•¿ï¼ˆé»˜è®¤ 16msï¼‰
  - `vad_min_speech_ms`: æœ€å°è¯­éŸ³é•¿åº¦ï¼ˆé»˜è®¤ 80msï¼‰
  - `vad_max_silence_ms`: æœ€å¤§é™éŸ³é•¿åº¦ï¼ˆé»˜è®¤ 160msï¼‰
- **è¿”å›ï¼š** ä¸éŸ³é¢‘ç­‰é•¿çš„ numpy æ•°ç»„ï¼Œ0 è¡¨ç¤ºé™éŸ³ï¼Œ1 è¡¨ç¤ºè¯­éŸ³

```python
def _save_vad_plot(audio: np.ndarray, mask: np.ndarray, sr: int, 
                  out_path: str, title: str)
```
- **åŠŸèƒ½ï¼š** ä¿å­˜æ³¢å½¢ + VAD æ©ç çš„å åŠ å›¾ï¼ˆä»…è°ƒè¯•æ¨¡å¼ä½¿ç”¨ï¼‰
- **ç”¨é€”ï¼š** å¯è§†åŒ– VAD æ•ˆæœï¼Œä¾¿äºå‚æ•°è°ƒä¼˜

##### 2.5 ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆå•å¯¹å¤„ç†ï¼‰
```python
def process_pair(pair: Tuple, verifier: Any, save_vad_dir: Optional[str], 
                ...) -> Dict
```
- **åŠŸèƒ½ï¼š** å¤„ç†å•ä¸ªéŸ³é¢‘å¯¹ï¼Œè®¡ç®—å£°çº¹ç›¸ä¼¼åº¦
- **æµç¨‹ï¼š**
  1. åŠ è½½æºéŸ³é¢‘å’Œ TTS éŸ³é¢‘ï¼Œé‡é‡‡æ ·è‡³ 16kHz
  2. å¦‚æœå¯ç”¨ VADï¼Œæå–æœ‰æ•ˆè¯­éŸ³ç‰‡æ®µï¼ˆéœ€è‡³å°‘ 200msï¼‰
  3. è°ƒç”¨ `verifier.verify_from_array` è®¡ç®—ç›¸ä¼¼åº¦
  4. å¦‚æœåœ¨è°ƒè¯•æ¨¡å¼ä¸”æä¾›äº† `save_vad_dir`ï¼Œä¿å­˜ VAD å¯è§†åŒ–å›¾
  5. è¿”å›ç»“æœå­—å…¸ï¼š`{success, similarity, source_path, tts_path, voiceprint_id, prompt_id, error}`
- **å¼‚å¸¸å¤„ç†ï¼š** æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œæ ‡è®°ä¸º `success=False`ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯

##### 2.6 å¤š GPU å¹¶è¡Œå¤„ç†
```python
def _worker_process(gpu_id: int, pairs: List[Tuple], model_dir: str, ...)
```
- **åŠŸèƒ½ï¼š** å•ä¸ª GPU è¿›ç¨‹çš„å·¥ä½œå‡½æ•°ï¼ˆç”¨äºå¤š GPU æ¨¡å¼ï¼‰
- **ç‰¹ç‚¹ï¼š**
  - ä½¿ç”¨ `multiprocessing.spawn` å¯åŠ¨å­è¿›ç¨‹ï¼Œé¿å… CUDA fork é—®é¢˜
  - æ¯ä¸ªå­è¿›ç¨‹ç‹¬ç«‹åŠ è½½æ¨¡å‹ï¼Œç»‘å®šåˆ°æŒ‡å®š GPU
  - ä½¿ç”¨é˜Ÿåˆ—ï¼ˆQueueï¼‰å‘ä¸»è¿›ç¨‹è¿”å›ç»“æœ
- **é€‚ç”¨åœºæ™¯ï¼š** æ•°æ®é‡å¤§ï¼ˆ>10000 å¯¹ï¼‰ä¸”æœ‰å¤šå¼  GPU æ—¶

##### 2.7 ç»“æœèšåˆä¸ä¿å­˜
```python
def aggregate_and_save(results: List[Dict], threshold: float, 
                      output_path: str, meta: Dict)
```
- **åŠŸèƒ½ï¼š** ç»Ÿè®¡ç›¸ä¼¼åº¦åˆ†å¸ƒï¼Œç”Ÿæˆç»“æœ JSON å’Œç­›é™¤åˆ—è¡¨
- **è¾“å‡ºå†…å®¹ï¼š**
  - **ç»“æœ JSON**ï¼š
    ```json
    {
      "timestamp": "ISO æ ¼å¼æ—¶é—´æˆ³",
      "meta": {é…ç½®ä¿¡æ¯ã€è¿è¡Œå‚æ•°},
      "statistics": {
        "total_pairs": æ€»é…å¯¹æ•°,
        "processed_pairs": æˆåŠŸè®¡ç®—çš„é…å¯¹æ•°,
        "failed_pairs": å¤„ç†å¤±è´¥çš„é…å¯¹æ•°,
        "passed_pairs": é€šè¿‡é˜ˆå€¼çš„é…å¯¹æ•°,
        "filtered_pairs": è¢«ç­›é™¤çš„é…å¯¹æ•°,
        "threshold": ç›¸ä¼¼åº¦é˜ˆå€¼,
        "similarity_stats": {
          "mean": å¹³å‡ç›¸ä¼¼åº¦,
          "median": ä¸­ä½æ•°,
          "std": æ ‡å‡†å·®,
          "min": æœ€å°å€¼,
          "max": æœ€å¤§å€¼
        }
      },
      "filter_results": [æ¯ä¸ªé…å¯¹çš„è¯¦ç»†ç»“æœ]
    }
    ```
  - **ç­›é™¤åˆ—è¡¨ TXT**ï¼šæ¯è¡Œä¸€ä¸ª TTS éŸ³é¢‘çš„ç»å¯¹è·¯å¾„ï¼ˆç›¸ä¼¼åº¦ < é˜ˆå€¼ï¼‰

##### 2.8 ä¸»å‡½æ•°
```python
def main()
```
- **æµç¨‹ï¼š**
  1. è§£æå‘½ä»¤è¡Œå‚æ•°
  2. æ£€æŸ¥è¾“å…¥è·¯å¾„æœ‰æ•ˆæ€§
  3. è°ƒç”¨ `build_pairs_from_mapping` æ„å»ºé…å¯¹
  4. åˆ¤æ–­ä½¿ç”¨å• GPUï¼ˆçº¿ç¨‹æ± ï¼‰è¿˜æ˜¯å¤š GPUï¼ˆå¤šè¿›ç¨‹ï¼‰æ¨¡å¼
  5. åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œéšæœºé‡‡æ ·å¹¶è®¾ç½® VAD å›¾ä¿å­˜ç›®å½•
  6. å¹¶è¡Œå¤„ç†æ‰€æœ‰é…å¯¹ï¼Œè®¡ç®—ç›¸ä¼¼åº¦
  7. è°ƒç”¨ `aggregate_and_save` ä¿å­˜ç»“æœ
  8. è¾“å‡ºå¤„ç†è€—æ—¶å’Œç»Ÿè®¡ä¿¡æ¯

**å…³é”®å†³ç­–é€»è¾‘ï¼š**
```python
# å¦‚æœæŒ‡å®šäº†å¤šä¸ª GPU ä¸”æ•°é‡ > 1ï¼Œä½¿ç”¨å¤šè¿›ç¨‹æ¨¡å¼
if num_gpus > 1:
    mp.set_start_method("spawn", force=True)
    # åˆ†ç‰‡æ•°æ®åˆ°å„ GPU
    # å¯åŠ¨ç‹¬ç«‹å­è¿›ç¨‹å¤„ç†
else:
    # å• GPU æˆ– CPUï¼šä½¿ç”¨ ThreadPoolExecutor çº¿ç¨‹æ± 
    verifier = WeSpeakerVerification(model_dir=args.model_dir, device=device_opt)
    with ThreadPoolExecutor(max_workers=args.num_workers) as ex:
        # æäº¤æ‰€æœ‰ä»»åŠ¡
```

---

#### 3. `multilingual_inference.py` - WeSpeaker å°è£…

**åŠŸèƒ½ï¼š** å°è£… WeSpeaker è¯´è¯äººéªŒè¯æ¨¡å‹ï¼Œæä¾›ç®€æ´çš„ API æ¥å£

**æ ¸å¿ƒç±»ï¼š**
```python
class WeSpeakerVerification:
    def __init__(self, model_dir: Optional[str] = None, 
                device: Optional[str] = None)
    
    def extract_embedding(self, audio_path: str) -> np.ndarray
    def extract_embedding_from_array(self, audio: np.ndarray, 
                                    sr: int) -> np.ndarray
    def verify(self, audio_path1: str, audio_path2: str) -> float
    def verify_from_array(self, audio1: np.ndarray, sr1: int, 
                         audio2: np.ndarray, sr2: int) -> float
```

**æ–¹æ³•è¯´æ˜ï¼š**

##### 3.1 åˆå§‹åŒ–
```python
def __init__(self, model_dir: Optional[str] = None, device: Optional[str] = None)
```
- **åŠŸèƒ½ï¼š** åŠ è½½ WeSpeaker æ¨¡å‹
- **å‚æ•°ï¼š**
  - `model_dir`: æ¨¡å‹ç›®å½•è·¯å¾„ï¼ˆsamresnet100ï¼‰
  - `device`: è®¡ç®—è®¾å¤‡ï¼ˆ"cuda" æˆ– "cpu"ï¼Œé»˜è®¤è‡ªåŠ¨æ£€æµ‹ï¼‰
- **å…³é”®å¤„ç†ï¼š**
  - åœ¨ CPU æ¨¡å¼ä¸‹è®¾ç½® `CUDA_VISIBLE_DEVICES=""` é¿å…æ„å¤–ä½¿ç”¨ GPU
  - è®¾ç½®ç¯å¢ƒå˜é‡å¼ºåˆ¶ä½¿ç”¨ soundfile åç«¯ï¼ˆè§£å†³ torchaudio ä¾èµ–é—®é¢˜ï¼‰
  - Mock torio æ‰©å±•ï¼Œé¿å… FFmpeg åŠ è½½å¯¼è‡´çš„æ®µé”™è¯¯

##### 3.2 ç‰¹å¾æå–
```python
def extract_embedding(self, audio_path: str) -> np.ndarray
def extract_embedding_from_array(self, audio: np.ndarray, sr: int) -> np.ndarray
```
- **åŠŸèƒ½ï¼š** æå–è¯´è¯äººç‰¹å¾å‘é‡ï¼ˆembeddingsï¼‰
- **è¾“å…¥ï¼š** éŸ³é¢‘æ–‡ä»¶è·¯å¾„æˆ–éŸ³é¢‘æ•°ç»„ï¼ˆ16kHz å•å£°é“ï¼‰
- **è¾“å‡ºï¼š** å½’ä¸€åŒ–çš„ç‰¹å¾å‘é‡ï¼ˆnumpy æ•°ç»„ï¼‰
- **ç”¨é€”ï¼š** å¯ç‹¬ç«‹ä½¿ç”¨æå–çš„ embeddings è¿›è¡Œèšç±»ã€æ£€ç´¢ç­‰ä»»åŠ¡

##### 3.3 ç›¸ä¼¼åº¦è®¡ç®—
```python
def verify(self, audio_path1: str, audio_path2: str) -> float
def verify_from_array(self, audio1: np.ndarray, sr1: int, 
                     audio2: np.ndarray, sr2: int) -> float
```
- **åŠŸèƒ½ï¼š** è®¡ç®—ä¸¤ä¸ªéŸ³é¢‘çš„å£°çº¹ç›¸ä¼¼åº¦
- **è¾“å…¥ï¼š** ä¸¤ä¸ªéŸ³é¢‘ï¼ˆæ–‡ä»¶è·¯å¾„æˆ–æ•°ç»„ï¼‰
- **è¾“å‡ºï¼š** ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆ-1 åˆ° 1 ä¹‹é—´ï¼Œè¶Šæ¥è¿‘ 1 è¶Šç›¸ä¼¼ï¼‰
- **å®ç°ï¼š** æå–ä¸¤ä¸ª embeddings åè®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦

**å…³é”®æŠ€æœ¯ç»†èŠ‚ï¼š**
1. **ç¯å¢ƒå˜é‡è®¾ç½®**ï¼ˆæ¨¡å—çº§åˆ«ï¼Œç¬¬ 13-20 è¡Œï¼‰
   ```python
   os.environ["TORCHAUDIO_USE_SOUNDFILE_LEGACY_INTERFACE"] = "1"
   os.environ["TORCHAUDIO_USE_BACKEND_DISPATCHER"] = "1"
   os.environ["TORIO_DISABLE_EXTENSIONS"] = "1"
   ```
   å¼ºåˆ¶ torchaudio ä½¿ç”¨ soundfile åç«¯ï¼Œé¿å…åŠ è½½ `libtorchaudio.so`

2. **Mock torio æ‰©å±•**ï¼ˆæ¨¡å—çº§åˆ«ï¼Œç¬¬ 34-41 è¡Œï¼‰
   ```python
   from unittest.mock import MagicMock
   _mock_torio_ext = MagicMock()
   sys.modules['torio._extension'] = _mock_torio_ext
   ```
   æ‹¦æˆª torio FFmpeg æ‰©å±•åŠ è½½ï¼Œé˜²æ­¢æ®µé”™è¯¯ï¼ˆè¯¦è§ FIX_LOG.mdï¼‰

3. **è®¾å¤‡ç®¡ç†**
   - CPU æ¨¡å¼ä¸‹ä¸»åŠ¨å±è”½ CUDA è®¾å¤‡
   - GPU æ¨¡å¼ä¸‹è‡ªåŠ¨é€‰æ‹©å¯ç”¨ GPU

---

#### 4. `config.json` - é…ç½®æ–‡ä»¶

**åŠŸèƒ½ï¼š** é›†ä¸­ç®¡ç†é»˜è®¤é…ç½®ï¼Œé¿å…ç¡¬ç¼–ç 

**é…ç½®é¡¹è¯´æ˜ï¼š**
```json
{
  "model": {
    "model_dir": "/path/to/samresnet100"  // WeSpeaker æ¨¡å‹è·¯å¾„
  },
  "threshold": 0.9,  // é»˜è®¤ç›¸ä¼¼åº¦é˜ˆå€¼
  "io": {
    "mapping_dir": "/path/to/mapping_jsons",  // æ˜ å°„ JSON ç›®å½•
    "tts_zero_shot": "/path/to/zero_shot",    // TTS è¾“å‡ºæ ¹ç›®å½•
    "wav_scp": [  // åŸå§‹éŸ³é¢‘ç´¢å¼•æ–‡ä»¶åˆ—è¡¨ï¼ˆå¯å¤šä¸ªï¼‰
      "/path/to/dataset1/wav.scp",
      "/path/to/dataset2/wav.scp"
    ],
    "results_dir": "/path/to/results",  // ç»“æœè¾“å‡ºç›®å½•
    "logs_dir": "/path/to/logs"         // æ—¥å¿—ç›®å½•
  },
  "runtime": {
    "num_workers": 2,   // å• GPU çº¿ç¨‹æ•°
    "num_gpus": 2,      // ä½¿ç”¨çš„ GPU æ•°é‡
    "use_ten_vad": true,  // æ˜¯å¦å¯ç”¨ TEN VAD
    "debug": {
      "enabled": false,  // æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
      "samples": 100,    // è°ƒè¯•é‡‡æ ·æ•°
      "dir": ""          // è°ƒè¯•è¾“å‡ºç›®å½•
    },
    "vad": {
      "frame_ms": 16,           // VAD å¸§é•¿ï¼ˆæ¯«ç§’ï¼‰
      "min_speech_ms": 160,     // æœ€å°è¯­éŸ³é•¿åº¦ï¼ˆæ¯«ç§’ï¼‰
      "max_silence_ms": 200     // æœ€å¤§é™éŸ³é•¿åº¦ï¼ˆæ¯«ç§’ï¼‰
    }
  }
}
```

**ä½¿ç”¨æ–¹å¼ï¼š**
- shell è„šæœ¬ä¼šè¯»å–æ­¤æ–‡ä»¶ä½œä¸ºé»˜è®¤å€¼
- å‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶
- å¯æ ¹æ®å…·ä½“é¡¹ç›®ä¿®æ”¹è·¯å¾„å’Œå‚æ•°

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### ç¯å¢ƒå‡†å¤‡

#### ä¾èµ–è¦æ±‚
```bash
# æ¨èä½¿ç”¨ SpeakerIdentify conda ç¯å¢ƒ
conda create -n SpeakerIdentify python=3.9
conda activate SpeakerIdentify

# æ ¸å¿ƒä¾èµ–
pip install torch torchaudio numpy
pip install wespeaker  # WeSpeaker åº“
pip install soundfile librosa tqdm
pip install ten_vad    # å¯é€‰ï¼šè¯­éŸ³æ´»åŠ¨æ£€æµ‹
pip install matplotlib # å¯é€‰ï¼šè°ƒè¯•æ¨¡å¼ç»˜å›¾
```

#### æ¨¡å‹å‡†å¤‡
ç¡®ä¿ WeSpeaker samresnet100 æ¨¡å‹å·²ä¸‹è½½å¹¶æ”¾ç½®åœ¨æŒ‡å®šè·¯å¾„ï¼š
```bash
# é»˜è®¤è·¯å¾„
/root/code/gitlab_repos/speakeridentify/InterUttVerify/Multilingual/samresnet100
```

---

### å¿«é€Ÿå¼€å§‹

#### åŸºç¡€ç”¨æ³•ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
```bash
cd /root/code/github_repos/DataFilter/tts_speech_voiceprint_filter

./run_voiceprint_filter.sh \
  --threshold 0.90 \
  --num_gpus 2 \
  --num_workers 8 \
  --verbose
```

#### è‡ªå®šä¹‰æ•°æ®è·¯å¾„
```bash
./run_voiceprint_filter.sh \
  --mapping_dir /custom/path/to/mappings \
  --tts_zero_shot /custom/path/to/zero_shot \
  --wav_scp /custom/path1/wav.scp \
  --wav_scp /custom/path2/wav.scp \
  --threshold 0.92 \
  --model_dir /path/to/samresnet100 \
  --output /custom/output/results.json \
  --num_gpus 4 \
  --verbose
```

#### è°ƒè¯•æ¨¡å¼ï¼ˆå°è§„æ¨¡æµ‹è¯•ï¼‰
```bash
./run_voiceprint_filter.sh \
  --debug \
  --debug_samples 50 \
  --debug_dir /tmp/vad_debug \
  --threshold 0.85 \
  --verbose
```
- éšæœºé‡‡æ · 50 å¯¹è¿›è¡Œæµ‹è¯•
- ä¿å­˜ VAD å¯è§†åŒ–å›¾åˆ° `/tmp/vad_debug`
- å¼ºåˆ¶ä½¿ç”¨å•è¿›ç¨‹ï¼Œé¿å…å¤š GPU å¼€é”€

---

### è¾“å…¥æ•°æ®æ ¼å¼

#### 1. æ˜ å°„ JSON æ–‡ä»¶

**æ ¼å¼ Aï¼šæ ‡å‡†å¯¹è±¡æ ¼å¼ï¼ˆæ¨èï¼‰**
```json
{
  "prompt_id_001": [
    {
      "voiceprint_id": "spk_12345",
      "source_utt": "prompt_id_001",      // æº utt_idï¼ˆå¯é€‰ï¼‰
      "source_path": "/abs/path/to/source.wav",  // æ˜¾å¼è·¯å¾„ï¼ˆå¯é€‰ï¼‰
      "tts_path": "/abs/path/to/tts.wav"  // TTS è·¯å¾„ï¼ˆå¯é€‰ï¼‰
    }
  ],
  "prompt_id_002": [...]
}
```

**æ ¼å¼ Bï¼šå…¼å®¹æ—§æ ¼å¼**
```json
{
  "prompt_id_001": [
    "spk_12345\tè¿™æ˜¯æ–‡æœ¬å†…å®¹"
  ],
  "prompt_id_002": [...]
}
```
- å­—ç¬¦ä¸²æ ¼å¼ä¼šè‡ªåŠ¨è§£æ voiceprint_idï¼ˆç¬¬ä¸€ä¸ªå­—æ®µï¼‰
- TTS è·¯å¾„æŒ‰çº¦å®šæ‹¼æ¥ï¼š`<zero_shot>/<prompt_id>/<voiceprint_id>.wav`

#### 2. Kaldi wav.scp æ–‡ä»¶

**æ ‡å‡†æ ¼å¼ï¼š**
```
utt_id_001 /absolute/path/to/audio1.wav
utt_id_002 /absolute/path/to/audio2.wav
prompt_id_001 /absolute/path/to/prompt1.wav
```

**è¯´æ˜ï¼š**
- æ¯è¡Œæ ¼å¼ï¼š`utt_id<ç©ºæ ¼>/absolute/path`
- å·¥å…·ä¼šæ„å»ºä¸‰ç§ç´¢å¼•ï¼šæŒ‰ utt_idã€æŒ‰æ–‡ä»¶å…¨åã€æŒ‰æ— æ‰©å±•åæ–‡ä»¶å
- æ”¯æŒå¤šä¸ª wav.scp æ–‡ä»¶ï¼Œä¼šåˆå¹¶ç´¢å¼•

#### 3. TTS zero_shot ç›®å½•ç»“æ„

**çº¦å®šç»“æ„ï¼š**
```
zero_shot/
â”œâ”€â”€ prompt_id_001/
â”‚   â”œâ”€â”€ spk_12345.wav
â”‚   â”œâ”€â”€ spk_67890.wav
â”‚   â””â”€â”€ ...
â”œâ”€â”€ prompt_id_002/
â”‚   â””â”€â”€ ...
```

**è¯´æ˜ï¼š**
- ç¬¬ä¸€å±‚ç›®å½•åä¸º prompt_idï¼ˆä¸æ˜ å°„ JSON çš„ key å¯¹åº”ï¼‰
- ç¬¬äºŒå±‚æ–‡ä»¶åä¸º `<voiceprint_id>.wav`

---

### è¾“å‡ºç»“æœ

#### 1. ç»“æœ JSON æ–‡ä»¶

**æ–‡ä»¶åï¼š** `tts_voiceprint_filter_results_YYYYMMDD_HHMMSS.json`

**å†…å®¹ç»“æ„ï¼š**
```json
{
  "timestamp": "2025-11-12T10:30:00",
  "meta": {
    "mapping_dir": "...",
    "tts_zero_shot": "...",
    "wav_scp": ["..."],
    "model_dir": "...",
    "num_workers": 8,
    "duration_sec": 123.45,
    "debug": {...}
  },
  "statistics": {
    "total_pairs": 1000,
    "processed_pairs": 980,
    "failed_pairs": 20,
    "passed_pairs": 850,
    "filtered_pairs": 130,
    "threshold": 0.90,
    "similarity_stats": {
      "mean": 0.912,
      "median": 0.925,
      "std": 0.073,
      "min": 0.654,
      "max": 0.989
    }
  },
  "filter_results": [
    {
      "success": true,
      "similarity": 0.945,
      "source_path": "/path/to/source.wav",
      "tts_path": "/path/to/tts.wav",
      "voiceprint_id": "spk_12345",
      "prompt_id": "prompt_001",
      "error": null
    },
    {
      "success": false,
      "similarity": null,
      "error": "Audio file not found"
    }
  ]
}
```

#### 2. ç­›é™¤åˆ—è¡¨ TXT æ–‡ä»¶

**æ–‡ä»¶åï¼š** `tts_voiceprint_filter_results_YYYYMMDD_HHMMSS_filtered_list.txt`

**å†…å®¹ï¼š** æ¯è¡Œä¸€ä¸ªéœ€è¦ç­›é™¤çš„ TTS éŸ³é¢‘è·¯å¾„ï¼ˆç›¸ä¼¼åº¦ < é˜ˆå€¼ï¼‰
```
/path/to/tts/spk_001.wav
/path/to/tts/spk_002.wav
...
```

**ç”¨é€”ï¼š**
- å¯ç”¨äºæ‰¹é‡åˆ é™¤ä¸åˆæ ¼éŸ³é¢‘
- å¯ç”¨äºæ ‡è®°éœ€è¦äººå·¥å¤æŸ¥çš„æ ·æœ¬

---

## ğŸ”§ å‚æ•°è°ƒä¼˜å»ºè®®

### ç›¸ä¼¼åº¦é˜ˆå€¼é€‰æ‹©

| é˜ˆå€¼èŒƒå›´ | ç­›é€‰ä¸¥æ ¼åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|----------|---------|
| 0.85-0.90 | å®½æ¾ | æ•°æ®é‡è¾ƒå°‘ï¼Œå…è®¸ä¸€å®šå£°çº¹å·®å¼‚ |
| 0.90-0.93 | é€‚ä¸­ï¼ˆæ¨èï¼‰ | é€šç”¨åœºæ™¯ï¼Œå¹³è¡¡è´¨é‡å’Œæ•°é‡ |
| 0.93-0.95 | ä¸¥æ ¼ | é«˜è´¨é‡è¦æ±‚ï¼Œå£°çº¹ä¸€è‡´æ€§ä¼˜å…ˆ |
| >0.95 | æä¸¥æ ¼ | å¯èƒ½è¿‡æ»¤è¿‡å¤šï¼Œå»ºè®®å…ˆå°è§„æ¨¡æµ‹è¯• |

**è°ƒä¼˜ç­–ç•¥ï¼š**
1. å…ˆç”¨è°ƒè¯•æ¨¡å¼éšæœºé‡‡æ · 100-200 å¯¹ï¼Œè§‚å¯Ÿç›¸ä¼¼åº¦åˆ†å¸ƒ
2. æŸ¥çœ‹ statistics.similarity_statsï¼Œæ ¹æ® mean å’Œ median è®¾ç½®é˜ˆå€¼
3. é˜ˆå€¼é€šå¸¸è®¾åœ¨ mean - 0.5*std åˆ° mean ä¹‹é—´

### VAD å‚æ•°è°ƒæ•´

```json
"vad": {
  "frame_ms": 16,           // å¸§é•¿ï¼šè¶Šå°è¶Šç²¾ç»†ï¼Œä½†è®¡ç®—é‡å¤§
  "min_speech_ms": 160,     // æœ€å°è¯­éŸ³ç‰‡æ®µï¼šè¿‡æ»¤çŸ­æš‚å™ªå£°
  "max_silence_ms": 200     // æœ€å¤§é™éŸ³ï¼šåˆå¹¶ä¸´è¿‘è¯­éŸ³ç‰‡æ®µ
}
```

**è°ƒæ•´å»ºè®®ï¼š**
- **è¯­éŸ³ç‰‡æ®µè¾ƒçŸ­**ï¼ˆå¦‚å•è¯çº§åˆ«ï¼‰ï¼š`min_speech_ms` é™è‡³ 100-120
- **èƒŒæ™¯å™ªå£°è¾ƒå¤š**ï¼šå¢å¤§ `max_silence_ms` è‡³ 300-400ï¼Œé¿å…ç‰‡æ®µè¿‡ç¢
- **ä¸ç¡®å®šæ—¶**ï¼šä½¿ç”¨è°ƒè¯•æ¨¡å¼ä¿å­˜ VAD å›¾ï¼Œå¯è§†åŒ–è°ƒæ•´æ•ˆæœ

### å¹¶è¡Œå‚æ•°ä¼˜åŒ–

#### å• GPU æ¨¡å¼ï¼ˆæ•°æ®é‡ < 5000 å¯¹ï¼‰
```bash
--num_gpus 1 \
--num_workers 8  # CPU æ ¸å¿ƒæ•° * 1.5
```

#### å¤š GPU æ¨¡å¼ï¼ˆæ•°æ®é‡ > 10000 å¯¹ï¼‰
```bash
--num_gpus 4     # æ ¹æ®å¯ç”¨ GPU æ•°é‡
--num_workers 2  # æ­¤å‚æ•°åœ¨å¤š GPU æ¨¡å¼ä¸‹æ— æ•ˆ
```

**æ€§èƒ½å‚è€ƒï¼š**
- å• GPU (V100)ï¼šçº¦ 100-150 å¯¹/ç§’
- 4 GPU å¹¶è¡Œï¼šçº¦ 350-450 å¯¹/ç§’
- VAD å¤„ç†ä¼šå¢åŠ  10-20% çš„æ—¶é—´å¼€é”€

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æŠ¥é”™ "ImportError: libtorchaudio.so not found"

**åŸå› ï¼š** torchaudio å®‰è£…ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ soundfile åç«¯ï¼ˆæ¨èï¼Œå·²åœ¨ä»£ç ä¸­å¤„ç†ï¼‰
# æ— éœ€é¢å¤–æ“ä½œï¼Œè„šæœ¬å·²è‡ªåŠ¨è®¾ç½®ç¯å¢ƒå˜é‡

# æ–¹æ¡ˆ 2ï¼šé‡æ–°å®‰è£… torchaudio
pip install --force-reinstall torchaudio

# æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ conda å®‰è£…
conda install -c pytorch torchaudio
```

### Q2: æŠ¥é”™ "Segmentation Fault" æˆ–æ®µé”™è¯¯

**åŸå› ï¼š** torio å°è¯•åŠ è½½ FFmpeg æ‰©å±•ï¼Œåœ¨ CPU æ¨¡å¼ä¸‹å´©æºƒ

**è§£å†³æ–¹æ¡ˆï¼š**
- å·²åœ¨ `multilingual_inference.py` ä¸­é€šè¿‡ Mock è§£å†³
- ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„è„šæœ¬
- è¯¦è§ `FIX_LOG.md`

### Q3: å¤§é‡æ ·æœ¬æ‰¾ä¸åˆ°æºéŸ³é¢‘

**å¯èƒ½åŸå› ä¸è§£å†³ï¼š**

1. **wav.scp è·¯å¾„ä¸æ­£ç¡®**
   - æ£€æŸ¥ `--wav_scp` å‚æ•°æ˜¯å¦æŒ‡å‘æ­£ç¡®æ–‡ä»¶
   - ç¡®è®¤ wav.scp ä¸­çš„è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„ä¸”æ–‡ä»¶å­˜åœ¨

2. **utt_id ä¸åŒ¹é…**
   - æ˜ å°„ JSON ä¸­çš„ prompt_id åº”ä¸ wav.scp ä¸­çš„ utt_id ä¸€è‡´
   - æˆ–åœ¨ JSON ä¸­æ˜¾å¼æä¾› `source_utt` å­—æ®µ

3. **éœ€è¦æ˜¾å¼è·¯å¾„**
   - åœ¨æ˜ å°„ JSON ä¸­æ·»åŠ  `source_path` å­—æ®µï¼š
     ```json
     {
       "voiceprint_id": "spk_001",
       "source_path": "/absolute/path/to/source.wav"
     }
     ```

### Q4: GPU å†…å­˜ä¸è¶³ï¼ˆOOMï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å‡å°‘å¹¶è¡Œæ•°
--num_workers 2  # é™ä½å• GPU çº¿ç¨‹æ•°

# æˆ–å‡å°‘ä½¿ç”¨çš„ GPU æ•°é‡ï¼ˆä¼šå¢åŠ æ€»æ—¶é—´ï¼‰
--num_gpus 2

# æç«¯æƒ…å†µï¼šä½¿ç”¨ CPUï¼ˆä¼šå¾ˆæ…¢ï¼‰
--device cpu --num_workers 4
```

### Q5: ç›¸ä¼¼åº¦æ™®éåä½

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥éŸ³é¢‘é‡‡æ ·ç‡æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä¸º 16kHz æˆ–è‡ªåŠ¨é‡é‡‡æ ·ï¼‰
2. æ£€æŸ¥éŸ³é¢‘è´¨é‡ï¼Œæ˜¯å¦å­˜åœ¨ä¸¥é‡å¤±çœŸæˆ–å™ªå£°
3. ä½¿ç”¨è°ƒè¯•æ¨¡å¼é‡‡æ ·è‹¥å¹²å¯¹ï¼Œäººå·¥å¬è¾¨ç¡®è®¤æ˜¯å¦ç¡®å®ä¸ç›¸ä¼¼
4. æ£€æŸ¥ TTS æ¨¡å‹æ˜¯å¦æ­£å¸¸ï¼Œç”Ÿæˆçš„éŸ³é¢‘æ˜¯å¦æ­£ç¡®
5. å°è¯•å…³é—­ VADï¼ˆå¯èƒ½è¯¯åˆ‡é™¤äº†æœ‰æ•ˆè¯­éŸ³ï¼‰ï¼š
   ```bash
   # ä¿®æ”¹ compute_similarity.py ä¸­ TEN_VAD_AVAILABLE = False
   ```

### Q6: å¤š GPU æ¨¡å¼å¡ä½æˆ–æ— å“åº”

**å¯èƒ½åŸå› ï¼š**
- å­è¿›ç¨‹æ­»é”æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å…ˆç”¨è°ƒè¯•æ¨¡å¼æµ‹è¯•å•è¿›ç¨‹æ˜¯å¦æ­£å¸¸
--debug --debug_samples 10

# å‡å°‘ GPU æ•°é‡æˆ–ä½¿ç”¨å• GPU
--num_gpus 1 --num_workers 8

# æ£€æŸ¥ GPU æ˜¯å¦è¢«å…¶ä»–è¿›ç¨‹å ç”¨
nvidia-smi
```

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

### æµ‹è¯•ç¯å¢ƒ
- CPU: Intel Xeon Gold 6248R @ 3.00GHz (48 cores)
- GPU: 4 Ã— NVIDIA Tesla V100 (32GB)
- æ•°æ®é›†: 10,000 éŸ³é¢‘å¯¹
- éŸ³é¢‘é•¿åº¦: å¹³å‡ 5 ç§’

### è¿è¡Œæ—¶é—´å¯¹æ¯”

| æ¨¡å¼ | GPU æ•°é‡ | å¹¶å‘æ•° | æ€»è€—æ—¶ | ååé‡ |
|------|---------|-------|-------|-------|
| CPU å•è¿›ç¨‹ | 0 | 8 | 1200s | 8.3 å¯¹/s |
| å• GPU å¤šçº¿ç¨‹ | 1 | 8 | 85s | 117 å¯¹/s |
| å¤š GPU å¹¶è¡Œ | 2 | - | 48s | 208 å¯¹/s |
| å¤š GPU å¹¶è¡Œ | 4 | - | 28s | 357 å¯¹/s |

### VAD å½±å“åˆ†æ
- **å¯ç”¨ VAD**ï¼šæ€»è€—æ—¶å¢åŠ  12-18%
- **ç›¸ä¼¼åº¦æå‡**ï¼šå¹³å‡ç›¸ä¼¼åº¦æé«˜ 0.02-0.04ï¼ˆå»é™¤é™éŸ³å™ªå£°å¹²æ‰°ï¼‰
- **å»ºè®®**ï¼šè´¨é‡ä¼˜å…ˆæ—¶å¯ç”¨ï¼Œé€Ÿåº¦ä¼˜å…ˆæ—¶å¯å…³é—­

---

## ğŸ”¬ æŠ€æœ¯åŸç†

### å£°çº¹è¯†åˆ«åŸç†

1. **ç‰¹å¾æå–**
   - ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆResNet-100ï¼‰ä»éŸ³é¢‘ä¸­æå–é«˜ç»´ç‰¹å¾å‘é‡ï¼ˆembeddingsï¼‰
   - Embeddings æ•æ‰è¯´è¯äººçš„å£°å­¦ç‰¹å¾ï¼ˆéŸ³è‰²ã€å‘éŸ³ä¹ æƒ¯ç­‰ï¼‰
   - è¾“å‡ºå‘é‡ç»´åº¦ï¼š512ï¼ˆsamresnet100ï¼‰

2. **ç›¸ä¼¼åº¦è®¡ç®—**
   - ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰ï¼š
     $$\text{similarity} = \frac{\mathbf{a} \cdot \mathbf{b}}{\|\mathbf{a}\| \|\mathbf{b}\|}$$
   - èŒƒå›´ï¼š-1 åˆ° 1ï¼ˆå®é™…é€šå¸¸åœ¨ 0.5-0.99ï¼‰
   - ç‰©ç†æ„ä¹‰ï¼šä¸¤ä¸ªå‘é‡çš„å¤¹è§’ä½™å¼¦å€¼ï¼Œè¶Šæ¥è¿‘ 1 è¡¨ç¤ºè¶Šç›¸ä¼¼

3. **WeSpeaker æ¨¡å‹**
   - é¢„è®­ç»ƒæ•°æ®ï¼šVoxCelebï¼ˆè¶…è¿‡ 100 ä¸‡æ¡éŸ³é¢‘ï¼Œ7000+ è¯´è¯äººï¼‰
   - å¤šè¯­è¨€æ”¯æŒï¼šä¸­æ–‡ã€è‹±æ–‡ã€æ—¥è¯­ç­‰
   - ç‰¹ç‚¹ï¼šå¯¹çŸ­éŸ³é¢‘ï¼ˆ1-10 ç§’ï¼‰æœ‰è‰¯å¥½æ€§èƒ½

### VADï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼‰ä½œç”¨

1. **å»é™¤é™éŸ³å’Œå™ªå£°**
   - åŸå§‹éŸ³é¢‘å¯èƒ½åŒ…å«å‰åé™éŸ³ã€èƒŒæ™¯å™ªå£°
   - è¿™äº›éè¯­éŸ³ç‰‡æ®µä¼šå¹²æ‰° embeddings æå–
   - VAD è¯†åˆ«å‡ºæœ‰æ•ˆè¯­éŸ³ç‰‡æ®µï¼Œä»…æå–è¿™äº›åŒºåŸŸç‰¹å¾

2. **TEN VAD æŠ€æœ¯**
   - åŸºäºæ·±åº¦å­¦ä¹ çš„ç«¯åˆ°ç«¯ VAD æ¨¡å‹
   - å¸§çº§æ£€æµ‹ï¼ˆ16ms å¸§é•¿ï¼‰
   - åå¤„ç†ï¼šåˆå¹¶çŸ­é™éŸ³ã€è¿‡æ»¤çŸ­è¯­éŸ³ç‰‡æ®µ

3. **å®éªŒæ•ˆæœ**
   - å¯¹å™ªå£°è¾ƒå¤šçš„æ•°æ®ï¼Œç›¸ä¼¼åº¦æå‡æ˜æ˜¾ï¼ˆ+0.03-0.05ï¼‰
   - å¯¹é«˜è´¨é‡å½•éŸ³å®¤æ•°æ®ï¼Œæå‡è¾ƒå°ï¼ˆ+0.01-0.02ï¼‰

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

- [WeSpeaker: Western Speaker Recognition Toolkit](https://github.com/wenet-e2e/wespeaker)
- [VoxCeleb: Large-scale speaker identification datasets](https://www.robots.ox.ac.uk/~vgg/data/voxceleb/)
- [Cosine Similarity in Speaker Verification](https://ieeexplore.ieee.org/document/8461375)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2025-11-12
- âœ¨ æ–°å¢ VAD å‚æ•°å¯é…ç½®ï¼ˆframe_ms, min_speech_ms, max_silence_msï¼‰
- âœ¨ æ–°å¢è°ƒè¯•æ¨¡å¼ï¼šéšæœºé‡‡æ ·ã€VAD å¯è§†åŒ–
- ğŸ› ä¿®å¤ torchaudio ä¾èµ–é—®é¢˜ï¼ˆMock torio æ‰©å±•ï¼‰
- ğŸ“ æ›´æ–° READMEï¼šè¯¦ç»†ä¸­æ–‡è§£é‡Šæ¯ä¸ªè„šæœ¬å’Œæµç¨‹

### 2025-11-11
- ğŸ› ä¿®å¤ CPU æ¨¡å¼æ®µé”™è¯¯ï¼ˆè¯¦è§ FIX_LOG.mdï¼‰
- âš¡ ä¼˜åŒ–å¤š GPU å¹¶è¡Œï¼šä½¿ç”¨ spawn é¿å… CUDA fork é—®é¢˜
- ğŸ“ æ·»åŠ  FIX_LOG.md è®°å½•é—®é¢˜ä¿®å¤è¿‡ç¨‹

### 2025-10-22
- ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ¨ æ”¯æŒ WeSpeaker å£°çº¹ç›¸ä¼¼åº¦è®¡ç®—
- âœ¨ æ”¯æŒå¤š GPU å¹¶è¡Œå¤„ç†
- âœ¨ æ”¯æŒ TEN VAD é¢„å¤„ç†

---

## ğŸ“§ è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤ Issue æˆ– Pull Request
- æŸ¥çœ‹é¡¹ç›® Wiki è·å–æ›´å¤šæ–‡æ¡£

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª MIT è®¸å¯è¯ã€‚è¯¦è§ LICENSE æ–‡ä»¶ã€‚
