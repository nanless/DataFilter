# TTSè¯­éŸ³å£°çº¹è¿‡æ»¤ç³»ç»Ÿ - è¯¦ç»†è¯´æ˜æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ•´ä½“æµç¨‹](#æ•´ä½“æµç¨‹)
- [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
- [è„šæœ¬è¯´æ˜](#è„šæœ¬è¯´æ˜)
- [é…ç½®æ–‡ä»¶](#é…ç½®æ–‡ä»¶)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [è¾“å‡ºè¯´æ˜](#è¾“å‡ºè¯´æ˜)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

---

## é¡¹ç›®æ¦‚è¿°

### åŠŸèƒ½ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª**åŸºäºå£°çº¹ç›¸ä¼¼åº¦çš„TTSï¼ˆæ–‡æœ¬è½¬è¯­éŸ³ï¼‰éŸ³é¢‘è´¨é‡ç­›é€‰ç³»ç»Ÿ**ã€‚ä¸»è¦ç”¨äºï¼š

1. **æ£€æµ‹TTSå…‹éš†éŸ³é¢‘è´¨é‡**ï¼šå¯¹æ¯”TTSç”Ÿæˆçš„å…‹éš†éŸ³é¢‘ä¸åŸå§‹æç¤ºéŸ³é¢‘(prompt)çš„å£°çº¹ç›¸ä¼¼åº¦
2. **è‡ªåŠ¨ç­›é€‰ä½è´¨é‡éŸ³é¢‘**ï¼šæ ¹æ®è®¾å®šçš„é˜ˆå€¼ï¼Œè‡ªåŠ¨è¿‡æ»¤å‡ºç›¸ä¼¼åº¦ä¸è¾¾æ ‡çš„éŸ³é¢‘
3. **æ‰¹é‡å¤„ç†èƒ½åŠ›**ï¼šæ”¯æŒå¤šGPUå¹¶è¡Œå¤„ç†å¤§è§„æ¨¡æ•°æ®é›†
4. **è°ƒè¯•æ¨¡å¼**ï¼šæä¾›å°æ ·æœ¬æµ‹è¯•å’Œå¯è§†åŒ–åŠŸèƒ½ï¼Œæ–¹ä¾¿è°ƒè¯•

### åº”ç”¨åœºæ™¯

- **TTSæ¨¡å‹è®­ç»ƒæ•°æ®æ¸…æ´—**ï¼šå»é™¤è´¨é‡ä¸ä½³çš„å…‹éš†éŸ³é¢‘
- **å£°çº¹éªŒè¯**ï¼šéªŒè¯TTSç³»ç»Ÿæ˜¯å¦å‡†ç¡®å¤ç°äº†ç›®æ ‡è¯´è¯äººçš„å£°çº¹ç‰¹å¾
- **æ•°æ®è´¨é‡è¯„ä¼°**ï¼šè¯„ä¼°TTSæ•°æ®é›†çš„æ•´ä½“è´¨é‡åˆ†å¸ƒ

### æ ¸å¿ƒæŠ€æœ¯

- **å£°çº¹è¯†åˆ«æ¨¡å‹**ï¼šWeSpeakerå¤šè¯­è¨€è¯´è¯äººéªŒè¯æ¨¡å‹ï¼ˆsamresnet100ï¼‰
- **è¯­éŸ³æ´»åŠ¨æ£€æµ‹**ï¼šTEN VADï¼ˆVoice Activity Detectionï¼‰
- **ç›¸ä¼¼åº¦è®¡ç®—**ï¼šä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰
- **å¹¶è¡Œå¤„ç†**ï¼šå¤šGPU/å¤šè¿›ç¨‹å¹¶è¡Œè®¡ç®—

---

## ç›®å½•ç»“æ„

```
tts_speech_voiceprint_filter_old/
â”œâ”€â”€ compute_similarity.py                # åŸºç¡€å£°çº¹ç›¸ä¼¼åº¦è®¡ç®—æ¨¡å—ï¼ˆæ”¯æŒå¤šç§æ¨¡å¼ï¼‰
â”œâ”€â”€ compute_similarity_prompts.py        # Prompt-Cloneé…å¯¹ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆä¸»ç¨‹åºï¼‰
â”œâ”€â”€ multilingual_inference.py            # WeSpeakerå£°çº¹æ¨¡å‹æ¨ç†å°è£…
â”œâ”€â”€ run_voiceprint_filter.sh            # ä¸»è¿è¡Œè„šæœ¬ï¼ˆShellï¼‰
â”œâ”€â”€ test_debug_mode.sh                  # è°ƒè¯•æ¨¡å¼æµ‹è¯•è„šæœ¬
â”œâ”€â”€ config.json                         # é…ç½®æ–‡ä»¶
â”œâ”€â”€ README.md                           # ç®€è¦è¯´æ˜
â”œâ”€â”€ README_è¯¦ç»†è¯´æ˜.md                   # æœ¬æ–‡ä»¶ï¼ˆè¯¦ç»†è¯´æ˜ï¼‰
â”œâ”€â”€ README_UPDATE.md                    # æ›´æ–°æ€»ç»“
â”œâ”€â”€ CHANGELOG.md                        # ä¿®æ”¹æ—¥å¿—
â”œâ”€â”€ DEBUG_MODE_README.md                # è°ƒè¯•æ¨¡å¼ä½¿ç”¨è¯´æ˜
â”œâ”€â”€ QUICK_START.md                      # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ test_output/                        # æµ‹è¯•è¾“å‡ºç›®å½•
â”‚   â””â”€â”€ debug/                          # è°ƒè¯•æ¨¡å¼VADå¯è§†åŒ–å›¾è¾“å‡º
â””â”€â”€ __pycache__/                        # Pythonç¼“å­˜æ–‡ä»¶
```

---

## æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¾“å…¥æ•°æ®                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ å­ç›®å½•1/éŸ³é¢‘  â”‚  â”‚ å­ç›®å½•2/éŸ³é¢‘  â”‚  â”‚ å­ç›®å½•N/éŸ³é¢‘  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   æ ¹ç›®å½•/*.jsonï¼ˆé…å¯¹å…³ç³»ï¼šprompt_id <-> clone_idï¼‰â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              éŸ³é¢‘ç´¢å¼•æ„å»ºï¼ˆæ–‡ä»¶ååŒ¹é…ï¼‰                        â”‚
â”‚  â€¢ æŒ‰æ–‡ä»¶åï¼ˆstemï¼‰ç´¢å¼•: filename_without_ext -> [paths]    â”‚
â”‚  â€¢ æŒ‰å®Œæ•´åï¼ˆbasenameï¼‰ç´¢å¼•: filename.ext -> [paths]        â”‚
â”‚  â€¢ ç²¾ç¡®åŒ¹é… > åŒ…å«åŒ¹é…                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é…å¯¹æ„å»ºï¼ˆPrompt-Clone Pairingï¼‰                â”‚
â”‚  â€¢ è¯»å–JSONæ–‡ä»¶ï¼Œæå–prompt_idå’Œclone_id                     â”‚
â”‚  â€¢ åœ¨å­ç›®å½•å’Œå…¨å±€ç´¢å¼•ä¸­æŸ¥æ‰¾å¯¹åº”éŸ³é¢‘æ–‡ä»¶                       â”‚
â”‚  â€¢ æ„å»º(prompt_audio, clone_audio)é…å¯¹åˆ—è¡¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤šGPUå¹¶è¡Œå¤„ç†ï¼ˆå¯é€‰å•è¿›ç¨‹ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  GPU 0   â”‚  â”‚  GPU 1   â”‚  â”‚  GPU N   â”‚                 â”‚
â”‚  â”‚ Worker 0 â”‚  â”‚ Worker 1 â”‚  â”‚ Worker N â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚       â†“              â†“              â†“                       â”‚
â”‚  å¤„ç†å­é›†      å¤„ç†å­é›†      å¤„ç†å­é›†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å•å¯¹éŸ³é¢‘å¤„ç†æµç¨‹                                 â”‚
â”‚  1. åŠ è½½éŸ³é¢‘ (soundfile/librosa)                            â”‚
â”‚  2. é‡é‡‡æ ·è‡³16kHz                                           â”‚
â”‚  3. åº”ç”¨TEN VADï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼‰                              â”‚
â”‚  4. æå–æœ‰æ•ˆè¯­éŸ³æ®µ                                           â”‚
â”‚  5. WeSpeakeræ¨¡å‹æå–embeddingï¼ˆå£°çº¹ç‰¹å¾å‘é‡ï¼‰               â”‚
â”‚  6. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦                                           â”‚
â”‚  7. å¯é€‰ï¼šä¿å­˜VADå¯è§†åŒ–å›¾ï¼ˆDebugæ¨¡å¼ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç»“æœèšåˆä¸è¾“å‡º                                   â”‚
â”‚  â€¢ æ”¶é›†æ‰€æœ‰workerçš„å¤„ç†ç»“æœ                                  â”‚
â”‚  â€¢ è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå‡å€¼ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®ç­‰ï¼‰                      â”‚
â”‚  â€¢ æ ¹æ®é˜ˆå€¼æ ‡è®°é€šè¿‡/ç­›é™¤                                      â”‚
â”‚  â€¢ ç”ŸæˆJSONç»“æœæ–‡ä»¶                                          â”‚
â”‚  â€¢ ç”Ÿæˆç­›é™¤åˆ—è¡¨æ–‡ä»¶ï¼ˆfiltered_list.txtï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
éŸ³é¢‘æ–‡ä»¶ â†’ åŠ è½½ â†’ é‡é‡‡æ ·(16kHz) â†’ VADæ£€æµ‹ â†’ æå–æœ‰æ•ˆè¯­éŸ³ 
    â†’ å£°çº¹æå–(WeSpeaker) â†’ embeddingå‘é‡ â†’ ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®— 
    â†’ é˜ˆå€¼åˆ¤æ–­ â†’ ç»“æœè¾“å‡º
```

---

## æ•´ä½“æµç¨‹

### æµç¨‹æ¦‚è§ˆ

æ•´ä¸ªç³»ç»Ÿçš„å¤„ç†æµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

#### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®å‡†å¤‡ä¸ç´¢å¼•æ„å»º

1. **æ‰«æç›®å½•ç»“æ„**
   - éå†æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•
   - æ‰«ææ”¯æŒçš„éŸ³é¢‘æ ¼å¼ï¼ˆ.wav, .mp3, .flac, .m4a, .oggç­‰ï¼‰
   - æ„å»ºæ–‡ä»¶ååˆ°è·¯å¾„çš„æ˜ å°„ç´¢å¼•

2. **è¯»å–é…å¯¹å…³ç³»**
   - è¯»å–æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰JSONæ–‡ä»¶
   - æ¯ä¸ªJSONæ–‡ä»¶å¯¹åº”ä¸€ä¸ªå­ç›®å½•
   - æå–prompt_idå’Œclone_idçš„é…å¯¹å…³ç³»

3. **éŸ³é¢‘åŒ¹é…**
   - ä¼˜å…ˆåœ¨JSONåŒåå­ç›®å½•ä¸­æŸ¥æ‰¾
   - ä½¿ç”¨å¤šçº§åŒ¹é…ç­–ç•¥ï¼šç²¾ç¡®åŒ¹é… â†’ basenameåŒ¹é… â†’ stemåŒ¹é… â†’ åŒ…å«åŒ¹é…
   - æ„å»ºå®Œæ•´çš„(prompt_audio_path, clone_audio_path)é…å¯¹åˆ—è¡¨

#### ç¬¬äºŒé˜¶æ®µï¼šå¹¶è¡Œå¤„ç†

1. **ä»»åŠ¡åˆ†é…**
   - å°†é…å¯¹åˆ—è¡¨å‡åŒ€åˆ†é…ç»™å¤šä¸ªGPU worker
   - æ¯ä¸ªworkerç‹¬ç«‹å¤„ç†ä¸€ä¸ªå­é›†
   - æ”¯æŒå•è¿›ç¨‹æ¨¡å¼ï¼ˆDebugæ—¶ï¼‰

2. **éŸ³é¢‘å¤„ç†**ï¼ˆæ¯ä¸ªworkeræ‰§è¡Œï¼‰
   - åŠ è½½éŸ³é¢‘æ–‡ä»¶
   - é‡é‡‡æ ·åˆ°16kHzï¼ˆWeSpeakerè¦æ±‚ï¼‰
   - åº”ç”¨VADæ£€æµ‹æœ‰æ•ˆè¯­éŸ³æ®µ
   - æå–å£°çº¹embedding
   - è®¡ç®—ç›¸ä¼¼åº¦

#### ç¬¬ä¸‰é˜¶æ®µï¼šç»“æœèšåˆä¸è¾“å‡º

1. **ç»“æœæ”¶é›†**
   - æ”¶é›†æ‰€æœ‰workerçš„å¤„ç†ç»“æœ
   - åˆå¹¶åˆ°ç»Ÿä¸€çš„ç»“æœåˆ—è¡¨

2. **ç»Ÿè®¡åˆ†æ**
   - è®¡ç®—ç›¸ä¼¼åº¦çš„å‡å€¼ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®ã€æœ€å¤§æœ€å°å€¼
   - ç»Ÿè®¡é€šè¿‡/å¤±è´¥/ç­›é™¤çš„æ•°é‡
   - è®¡ç®—å¤„ç†æ—¶é—´

3. **æ–‡ä»¶è¾“å‡º**
   - ç”Ÿæˆè¯¦ç»†çš„JSONç»“æœæ–‡ä»¶
   - ç”Ÿæˆç­›é™¤åˆ—è¡¨æ–‡æœ¬æ–‡ä»¶
   - Debugæ¨¡å¼ä¸‹ç”ŸæˆVADå¯è§†åŒ–å›¾

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. multilingual_inference.py

#### åŠŸèƒ½æ¦‚è¿°

è¿™æ˜¯**WeSpeakerå£°çº¹è¯†åˆ«æ¨¡å‹çš„Pythonå°è£…**ï¼Œæä¾›äº†ç®€æ´æ˜“ç”¨çš„APIæ¥å£ã€‚

#### æ ¸å¿ƒç±»ï¼šWeSpeakerVerification

**åˆå§‹åŒ–**ï¼š
```python
def __init__(self, model_dir: Optional[str] = None, device: Optional[str] = None)
```
- `model_dir`ï¼šæ¨¡å‹ç›®å½•è·¯å¾„ï¼ˆåŒ…å«config.yamlå’Œæ¨¡å‹æ–‡ä»¶ï¼‰
- `device`ï¼šè®¡ç®—è®¾å¤‡ï¼ˆ'cuda'æˆ–'cpu'ï¼Œé»˜è®¤è‡ªåŠ¨æ£€æµ‹ï¼‰

**ä¸»è¦æ–¹æ³•**ï¼š

1. **extract_embedding(audio_path)**
   - ä»éŸ³é¢‘æ–‡ä»¶æå–å£°çº¹embeddingå‘é‡
   - è¿”å›ï¼šnumpyæ•°ç»„ï¼Œå½¢çŠ¶ä¸º(embedding_dim,)ï¼Œé€šå¸¸ä¸º192ç»´

2. **extract_embedding_array(audio, sr)**
   - ç›´æ¥ä»å†…å­˜ä¸­çš„æ³¢å½¢æ•°ç»„æå–embedding
   - é¿å…å†™ä¸´æ—¶æ–‡ä»¶ï¼Œæé«˜æ•ˆç‡
   - ä½¿ç”¨WeSpeakerçš„`extract_embedding_from_pcm`æ¥å£

3. **compute_similarity(embedding1, embedding2)**
   - è®¡ç®—ä¸¤ä¸ªembeddingå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
   - è¿”å›ï¼šfloatï¼ŒèŒƒå›´[0, 1]ï¼Œå€¼è¶Šå¤§è¡¨ç¤ºè¶Šç›¸ä¼¼

4. **verify_speakers(audio_path1, audio_path2, threshold)**
   - å®Œæ•´çš„è¯´è¯äººéªŒè¯æµç¨‹
   - è¿”å›ï¼š(ç›¸ä¼¼åº¦, è¯¦ç»†ä¿¡æ¯å­—å…¸)

5. **batch_extract_embeddings(audio_paths)**
   - æ‰¹é‡æå–å¤šä¸ªéŸ³é¢‘çš„embedding
   - è¿”å›ï¼š{éŸ³é¢‘è·¯å¾„: embedding}å­—å…¸

#### æŠ€æœ¯è¦ç‚¹

**ç¯å¢ƒå˜é‡è®¾ç½®**ï¼ˆå¿…é¡»åœ¨å¯¼å…¥torchå‰ï¼‰ï¼š
```python
os.environ["TORCHAUDIO_USE_SOUNDFILE_LEGACY_INTERFACE"] = "1"
os.environ["TORCHAUDIO_USE_BACKEND_DISPATCHER"] = "1"
os.environ["TORIO_DISABLE_EXTENSIONS"] = "1"
```
- å¼ºåˆ¶ä½¿ç”¨soundfileåç«¯ï¼Œé¿å…åŠ è½½libtorchaudio.so
- ç¦ç”¨torioçš„FFmpegæ‰©å±•ï¼Œé¿å…æ®µé”™è¯¯

**Mock torioæ‰©å±•**ï¼š
```python
from unittest.mock import MagicMock
_mock_torio_ext = MagicMock()
sys.modules['torio._extension'] = _mock_torio_ext
```
- é˜²æ­¢torioç›¸å…³çš„å´©æºƒé—®é¢˜
- ä¿®å¤MagicMockæ¯”è¾ƒé”™è¯¯

#### ä½¿ç”¨ç¤ºä¾‹

```python
# åˆå§‹åŒ–æ¨¡å‹
verifier = WeSpeakerVerification(
    model_dir="/path/to/samresnet100",
    device='cuda'
)

# æå–embedding
emb1 = verifier.extract_embedding("audio1.wav")
emb2 = verifier.extract_embedding("audio2.wav")

# è®¡ç®—ç›¸ä¼¼åº¦
similarity = verifier.compute_similarity(emb1, emb2)
print(f"ç›¸ä¼¼åº¦: {similarity:.4f}")

# æˆ–è€…ä¸€æ­¥å®Œæˆ
similarity, details = verifier.verify_speakers("audio1.wav", "audio2.wav", threshold=0.7)
```

---

### 2. compute_similarity.py

#### åŠŸèƒ½æ¦‚è¿°

è¿™æ˜¯**åŸºç¡€å£°çº¹ç›¸ä¼¼åº¦è®¡ç®—æ¨¡å—**ï¼Œæä¾›äº†æ ¸å¿ƒçš„éŸ³é¢‘å¤„ç†å’Œç›¸ä¼¼åº¦è®¡ç®—åŠŸèƒ½ã€‚æ”¯æŒå¤šç§å·¥ä½œæ¨¡å¼ï¼š
- Prompt-Cloneæ¨¡å¼
- Voiceprint-TTSæ¨¡å¼
- è‡ªå®šä¹‰é…å¯¹æ¨¡å¼

#### æ ¸å¿ƒå‡½æ•°

##### 2.1 éŸ³é¢‘ç´¢å¼•ä¸æŸ¥æ‰¾

**read_wav_scp(paths)**
- è¯»å–Kaldiæ ¼å¼çš„wav.scpæ–‡ä»¶
- è¿”å›ä¸‰ç§ç´¢å¼•ï¼šby_idï¼ˆutt_idâ†’è·¯å¾„ï¼‰ã€by_basenameã€by_stem
- ç”¨äºæŸ¥æ‰¾promptéŸ³é¢‘çš„ä½ç½®

**find_source_wav(voiceprint_id, hint_utt, hint_path, ...)**
- æ ¹æ®å¤šç§çº¿ç´¢æŸ¥æ‰¾æºéŸ³é¢‘æ–‡ä»¶
- ä¼˜å…ˆçº§ï¼šæ˜¾å¼è·¯å¾„ > utt_id > ç²¾ç¡®stemåŒ¹é… > basenameåŒ¹é… > åŒ…å«åŒ¹é…
- æ”¯æŒçµæ´»çš„æ–‡ä»¶ååŒ¹é…ç­–ç•¥

##### 2.2 VADï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼‰

**_apply_ten_vad_refined(wav, sr, ...)**
- ä½¿ç”¨TEN VADæ£€æµ‹è¯­éŸ³æ®µ
- å‚æ•°ï¼š
  - `frame_ms`ï¼šå¸§é•¿ï¼ˆé»˜è®¤16msï¼‰
  - `min_speech_ms`ï¼šæœ€çŸ­è¯­éŸ³æ®µï¼ˆé»˜è®¤160msï¼‰
  - `max_silence_ms`ï¼šæœ€é•¿é™éŸ³å¡«è¡¥ï¼ˆé»˜è®¤200msï¼‰
- è¿”å›ï¼šå¸ƒå°”æ©ç æ•°ç»„ï¼ŒTrueè¡¨ç¤ºæœ‰æ•ˆè¯­éŸ³å¸§

**_mask_to_segments(mask, sr, frame_ms)**
- å°†VADæ©ç è½¬æ¢ä¸ºæ—¶é—´åŒºé—´åˆ—è¡¨
- è¿”å›ï¼š[(start_sec, end_sec), ...]

##### 2.3 éŸ³é¢‘å¤„ç†

**process_pair(prompt_audio, clone_audio, model, ...)**
- å¤„ç†å•å¯¹éŸ³é¢‘çš„å®Œæ•´æµç¨‹
- æ­¥éª¤ï¼š
  1. åŠ è½½éŸ³é¢‘ï¼ˆæ”¯æŒsoundfileå’Œlibrosaï¼‰
  2. é‡é‡‡æ ·åˆ°16kHz
  3. åº”ç”¨VADæ£€æµ‹
  4. æå–æœ‰æ•ˆè¯­éŸ³æ®µ
  5. è®¡ç®—å£°çº¹embedding
  6. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
  7. å¯é€‰ï¼šä¿å­˜VADå¯è§†åŒ–å›¾
- è¿”å›ï¼šç›¸ä¼¼åº¦å’Œè¯¦ç»†ä¿¡æ¯

**_save_vad_plot(wav, sr, mask, ...)**
- ä¿å­˜æ³¢å½¢+VADæ©ç çš„å¯è§†åŒ–å›¾
- ç»¿è‰²åŒºåŸŸï¼šVADæ£€æµ‹çš„æœ‰æ•ˆè¯­éŸ³æ®µ
- ç”¨äºè°ƒè¯•å’Œè´¨é‡æ£€æŸ¥

##### 2.4 å¤šè¿›ç¨‹å¤„ç†

**_worker_process(gpu_id, pairs_chunk, ...)**
- å•ä¸ªGPU workerçš„å¤„ç†å‡½æ•°
- åœ¨å­è¿›ç¨‹ä¸­åˆå§‹åŒ–æ¨¡å‹
- å¤„ç†åˆ†é…çš„é…å¯¹å­é›†
- è¿”å›å¤„ç†ç»“æœ

**_split_even(lst, n)**
- å°†åˆ—è¡¨å‡åŒ€åˆ†å‰²ä¸ºnä»½
- ç”¨äºä»»åŠ¡åˆ†é…

##### 2.5 ç»“æœèšåˆ

**aggregate_and_save(results, output_path, threshold, ...)**
- èšåˆæ‰€æœ‰workerçš„ç»“æœ
- è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
- ç”ŸæˆJSONç»“æœæ–‡ä»¶
- ç”Ÿæˆç­›é™¤åˆ—è¡¨æ–‡ä»¶

#### ä½¿ç”¨ç¤ºä¾‹

```python
# å¤„ç†å•å¯¹éŸ³é¢‘
similarity, details = process_pair(
    prompt_audio="prompt.wav",
    clone_audio="clone.wav",
    model=verifier_model,
    threshold=0.9,
    vad_frame_ms=16,
    vad_min_speech_ms=160,
    vad_max_silence_ms=200
)

print(f"ç›¸ä¼¼åº¦: {similarity:.4f}")
print(f"æ˜¯å¦é€šè¿‡: {details['pass']}")
print(f"VAD segments: {details['vad']['src_segments']}")
```

---

### 3. compute_similarity_prompts.py

#### åŠŸèƒ½æ¦‚è¿°

è¿™æ˜¯**Prompt-Cloneæ¨¡å¼çš„ä¸»ç¨‹åº**ï¼Œå®ç°äº†å®Œæ•´çš„æ•°æ®å¤„ç†æµç¨‹ï¼š
- æ‰«æå­ç›®å½•éŸ³é¢‘æ–‡ä»¶
- è¯»å–JSONé…å¯¹å…³ç³»
- æ„å»ºéŸ³é¢‘ç´¢å¼•
- å¤šGPUå¹¶è¡Œå¤„ç†
- ç»“æœè¾“å‡º

#### æ ¸å¿ƒå‡½æ•°

##### 3.1 éŸ³é¢‘ç´¢å¼•æ„å»º

**_scan_subdir_audio_indices(subdir_path)**
- æ‰«æå•ä¸ªå­ç›®å½•çš„æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶
- è¿”å›ï¼š(by_stemç´¢å¼•, by_basenameç´¢å¼•)

**_find_audio_by_id(audio_id, ...)**
- æ ¹æ®éŸ³é¢‘IDæŸ¥æ‰¾éŸ³é¢‘æ–‡ä»¶
- ä¼˜å…ˆåœ¨å­ç›®å½•ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼ˆå¯¹åº”JSONæ–‡ä»¶çš„å­ç›®å½•ï¼‰
- å¦‚æœæ‰¾ä¸åˆ°ï¼Œåœ¨å…¨å±€ç´¢å¼•ä¸­æŸ¥æ‰¾
- åŒ¹é…ç­–ç•¥ï¼šç²¾ç¡®stemåŒ¹é… > ç²¾ç¡®basenameåŒ¹é… > åŒ…å«åŒ¹é…

##### 3.2 é…å¯¹æ„å»º

**build_pairs_from_prompt_clone_structure(root_dir, wav_scp_paths, debug, debug_samples)**
- æ‰«ææ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•å’ŒJSONæ–‡ä»¶
- è¯»å–æ¯ä¸ªJSONæ–‡ä»¶çš„é…å¯¹å…³ç³»
- æ„å»ºå®Œæ•´çš„é…å¯¹åˆ—è¡¨
- Debugæ¨¡å¼ï¼šéšæœºæ‰“ä¹±å¹¶é‡‡æ ·

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. æ‰«ææ‰€æœ‰å­ç›®å½•ï¼Œæ„å»ºå…¨å±€éŸ³é¢‘ç´¢å¼•
2. éå†æ¯ä¸ªJSONæ–‡ä»¶
3. å¯¹äºæ¯ä¸ªJSONä¸­çš„æ¡ç›®ï¼š
   - æå–prompt_idå’Œclone_id
   - åœ¨å¯¹åº”çš„å­ç›®å½•ä¸­æŸ¥æ‰¾éŸ³é¢‘æ–‡ä»¶
   - æ„å»º(prompt_audio, clone_audio, metadata)é…å¯¹
4. Debugæ¨¡å¼ä¸‹éšæœºé‡‡æ ·æŒ‡å®šæ•°é‡

##### 3.3 å¤šè¿›ç¨‹å¤„ç†

**_worker_process_with_env(gpu_id, pairs_chunk, ...)**
- è®¾ç½®GPUç¯å¢ƒï¼ˆCUDA_VISIBLE_DEVICESï¼‰
- åˆå§‹åŒ–WeSpeakeræ¨¡å‹
- é€å¯¹å¤„ç†éŸ³é¢‘ï¼ˆè°ƒç”¨compute_similarity.process_pairï¼‰
- è¿”å›å¤„ç†ç»“æœåˆ—è¡¨

**main()å‡½æ•°**
- è§£æå‘½ä»¤è¡Œå‚æ•°
- æ„å»ºé…å¯¹åˆ—è¡¨
- æ ¹æ®num_gpuså†³å®šå•è¿›ç¨‹æˆ–å¤šè¿›ç¨‹
- è°ƒç”¨workerå¤„ç†
- èšåˆç»“æœå¹¶ä¿å­˜

#### å…³é”®ç‰¹æ€§

**çµæ´»çš„æ–‡ä»¶åŒ¹é…**ï¼š
- æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼
- å¤šçº§åŒ¹é…ç­–ç•¥
- å®¹é”™æœºåˆ¶ï¼ˆæ‰¾ä¸åˆ°æ–‡ä»¶æ—¶è·³è¿‡ï¼Œä¸ç»ˆæ­¢ç¨‹åºï¼‰

**Debugæ¨¡å¼**ï¼š
- éšæœºé‡‡æ ·å°æ‰¹é‡æ•°æ®
- ä¿å­˜VADå¯è§†åŒ–å›¾
- å¼ºåˆ¶å•è¿›ç¨‹CPUæ¨¡å¼ï¼ˆç¨³å®šæ€§ä¼˜å…ˆï¼‰
- è¯¦ç»†çš„è¿›åº¦æ—¥å¿—

**å¤šGPUæ”¯æŒ**ï¼š
- è‡ªåŠ¨åˆ†é…ä»»åŠ¡åˆ°å„GPU
- æ¯ä¸ªGPUç‹¬ç«‹åŠ è½½æ¨¡å‹
- è¿›ç¨‹é—´æ— å…±äº«ï¼Œé¿å…GILé”

#### å‘½ä»¤è¡Œå‚æ•°

```bash
python3 compute_similarity_prompts.py \
  --root_dir /path/to/voiceclone_child_20250804 \     # æ ¹ç›®å½•
  --threshold 0.9 \                                    # ç›¸ä¼¼åº¦é˜ˆå€¼
  --model_dir /path/to/samresnet100 \                 # æ¨¡å‹è·¯å¾„
  --num_gpus 8 \                                       # GPUæ•°é‡
  --num_workers 8 \                                    # å¹¶è¡Œçº¿ç¨‹æ•°
  --output /path/to/results.json \                    # è¾“å‡ºæ–‡ä»¶
  --wav_scp /path/to/wav.scp \                        # å¯é€‰ï¼špromptéŸ³é¢‘ç´¢å¼•
  --vad_frame_ms 16 \                                  # VADå¸§é•¿
  --vad_min_speech_ms 160 \                           # VADæœ€çŸ­è¯­éŸ³
  --vad_max_silence_ms 200 \                          # VADæœ€é•¿é™éŸ³
  --debug \                                            # å¯ç”¨è°ƒè¯•æ¨¡å¼
  --debug_samples 100 \                               # è°ƒè¯•é‡‡æ ·æ•°
  --debug_dir ./debug_output \                        # è°ƒè¯•è¾“å‡ºç›®å½•
  --verbose                                            # è¯¦ç»†æ—¥å¿—
```

---

## è„šæœ¬è¯´æ˜

### 1. run_voiceprint_filter.sh

#### åŠŸèƒ½

**ä¸»è¿è¡Œè„šæœ¬**ï¼Œæä¾›äº†å‹å¥½çš„Shellæ¥å£ï¼Œå°è£…äº†Pythonè„šæœ¬çš„è°ƒç”¨ã€‚

#### æ ¸å¿ƒåŠŸèƒ½

1. **å‚æ•°è§£æ**
   - è§£æå‘½ä»¤è¡Œå‚æ•°
   - è®¾ç½®é»˜è®¤å€¼
   - å‚æ•°éªŒè¯

2. **ç¯å¢ƒå‡†å¤‡**
   - æ£€æŸ¥å¹¶æ¿€æ´»condaç¯å¢ƒï¼ˆSpeakerIdentifyï¼‰
   - åˆ›å»ºè¾“å‡ºç›®å½•
   - ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„è¾“å‡ºæ–‡ä»¶å

3. **é…ç½®ç®¡ç†**
   - æ”¯æŒä»config.jsonè¯»å–é…ç½®
   - å‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶
   - çµæ´»çš„å‚æ•°è¦†ç›–æœºåˆ¶

4. **å‘½ä»¤æ„å»º**
   - æ„å»ºå®Œæ•´çš„Pythonå‘½ä»¤
   - ä¼ é€’æ‰€æœ‰å‚æ•°
   - å½©è‰²è¾“å‡ºï¼Œæ˜“äºé˜…è¯»

#### ä½¿ç”¨æ–¹æ³•

```bash
# åŸºæœ¬ç”¨æ³•
./run_voiceprint_filter.sh --threshold 0.9 --verbose

# å®Œæ•´ç¤ºä¾‹
./run_voiceprint_filter.sh \
  --prompt_root /root/group-shared/voiceprint/share/voiceclone_child_20250804 \
  --threshold 0.9 \
  --model_dir /path/to/samresnet100 \
  --num_gpus 8 \
  --num_workers 8 \
  --output /path/to/output.json \
  --vad_frame_ms 16 \
  --vad_min_speech_ms 160 \
  --vad_max_silence_ms 200 \
  --verbose

# Debugæ¨¡å¼
./run_voiceprint_filter.sh \
  --debug \
  --debug_samples 100 \
  --debug_dir ./debug_output \
  --verbose
```

#### å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--threshold` | ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰ | 0.70 |
| `--model_dir` | WeSpeakeræ¨¡å‹ç›®å½• | `/root/code/gitlab_repos/.../samresnet100` |
| `--num_gpus` | GPUæ•°é‡ | 4 |
| `--num_workers` | å¹¶è¡Œçº¿ç¨‹æ•° | 4 |
| `--output` | è¾“å‡ºæ–‡ä»¶è·¯å¾„ | è‡ªåŠ¨ç”Ÿæˆï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰ |
| `--prompt_root` | æ ¹ç›®å½• | `/root/group-shared/.../voiceclone_child_20250804` |
| `--prompt_results_dir` | ç»“æœè¾“å‡ºç›®å½• | `.../tts_prompt_clone_similarity/results` |
| `--prompt_logs_dir` | æ—¥å¿—ç›®å½• | `.../tts_prompt_clone_similarity/logs` |
| `--wav_scp` | Kaldi wav.scpè·¯å¾„ï¼ˆå¯å¤šæ¬¡ä¼ å…¥ï¼‰ | é»˜è®¤4ä¸ªè·¯å¾„ |
| `--vad_frame_ms` | VADå¸§é•¿ï¼ˆmsï¼‰ | 16 |
| `--vad_min_speech_ms` | VADæœ€çŸ­è¯­éŸ³ï¼ˆmsï¼‰ | 160 |
| `--vad_max_silence_ms` | VADæœ€é•¿é™éŸ³ï¼ˆmsï¼‰ | 200 |
| `--debug` | å¯ç”¨è°ƒè¯•æ¨¡å¼ | false |
| `--debug_samples` | è°ƒè¯•é‡‡æ ·æ•° | 100 |
| `--debug_dir` | è°ƒè¯•è¾“å‡ºç›®å½• | "" |
| `--verbose` | è¯¦ç»†æ—¥å¿— | true |
| `-h, --help` | æ˜¾ç¤ºå¸®åŠ© | - |

#### ç‰¹æ€§

- âœ… å½©è‰²è¾“å‡ºï¼Œæ˜“äºé˜…è¯»
- âœ… å‚æ•°éªŒè¯
- âœ… é”™è¯¯å¤„ç†
- âœ… è‡ªåŠ¨ç¯å¢ƒæ¿€æ´»
- âœ… çµæ´»çš„é…ç½®è¦†ç›–

---

### 2. test_debug_mode.sh

#### åŠŸèƒ½

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬**ï¼Œç”¨äºéªŒè¯Debugæ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæ£€æŸ¥MagicMocké”™è¯¯æ˜¯å¦å·²ä¿®å¤ã€‚

#### æµ‹è¯•æµç¨‹

1. **ç¯å¢ƒæ£€æŸ¥**
   - æ£€æŸ¥condaç¯å¢ƒ
   - æ£€æŸ¥æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨

2. **æ‰§è¡Œæµ‹è¯•**
   - è¿è¡Œ10ä¸ªæ ·æœ¬çš„å¿«é€Ÿæµ‹è¯•
   - å¯ç”¨Debugæ¨¡å¼
   - å¯ç”¨VADå¯è§†åŒ–

3. **ç»“æœéªŒè¯**
   - æ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
   - æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æœå®‰è£…äº†jqï¼‰
   - æ£€æŸ¥å¤±è´¥æ ·æœ¬
   - ç»Ÿè®¡VADå¯è§†åŒ–å›¾æ•°é‡

4. **è¾“å‡ºæŠ¥å‘Š**
   - æ˜¾ç¤ºæµ‹è¯•æ˜¯å¦æˆåŠŸ
   - æ˜¾ç¤ºè¯¦ç»†çš„ç»“æœæ‘˜è¦

#### ä½¿ç”¨æ–¹æ³•

```bash
# ç›´æ¥è¿è¡Œ
./test_debug_mode.sh

# é¢„æœŸè¾“å‡º
========================================
   æµ‹è¯• Debug æ¨¡å¼
========================================

æ¿€æ´» SpeakerIdentify ç¯å¢ƒ...
æµ‹è¯•å‚æ•°ï¼š
  æ ¹ç›®å½•: /root/group-shared/voiceprint/share/voiceclone_child_20250804
  è¾“å‡ºæ–‡ä»¶: test_output/debug_test_20251112_143025.json
  è°ƒè¯•ç›®å½•: test_output/debug
  æ ·æœ¬æ•°: 10

å¼€å§‹æµ‹è¯•...
[æ‰§è¡Œè¿‡ç¨‹...]

========================================
   æµ‹è¯•æˆåŠŸï¼
========================================

ç»“æœæ‘˜è¦ï¼š
ç»Ÿè®¡ä¿¡æ¯ï¼š
{
  "total_pairs": 10,
  "processed_pairs": 10,
  ...
}

ç”Ÿæˆçš„ VAD å›¾ï¼š
  å…± 20 ä¸ªæ–‡ä»¶
  ä½ç½®: test_output/debug

âœ“ Debug æ¨¡å¼å·¥ä½œæ­£å¸¸
âœ“ MagicMock é”™è¯¯å·²ä¿®å¤
```

#### è¾“å‡ºæ–‡ä»¶

- `test_output/debug_test_<timestamp>.json`ï¼šè¯¦ç»†ç»“æœ
- `test_output/debug_test_<timestamp>_filtered_list.txt`ï¼šç­›é™¤åˆ—è¡¨
- `test_output/debug/*.png`ï¼šVADå¯è§†åŒ–å›¾

---

## é…ç½®æ–‡ä»¶

### config.json

#### ç»“æ„

```json
{
  "model": {
    "model_dir": "/root/code/gitlab_repos/speakeridentify/InterUttVerify/Multilingual/samresnet100"
  },
  "threshold": 0.9,
  "runtime": {
    "num_workers": 2,
    "num_gpus": 2,
    "prompt_flow": {
      "root_dir": "/root/group-shared/voiceprint/share/voiceclone_child_20250804",
      "results_dir": "/root/group-shared/.../results",
      "logs_dir": "/root/group-shared/.../logs"
    },
    "debug": {
      "enabled": false,
      "samples": 100,
      "dir": ""
    },
    "vad": {
      "frame_ms": 16,
      "min_speech_ms": 160,
      "max_silence_ms": 200
    }
  }
}
```

#### é…ç½®é¡¹è¯´æ˜

##### modelé…ç½®
- `model_dir`ï¼šWeSpeakeræ¨¡å‹ç›®å½•è·¯å¾„

##### thresholdé…ç½®
- `threshold`ï¼šç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰ï¼Œä½äºæ­¤å€¼å°†è¢«ç­›é™¤

##### runtimeé…ç½®

**åŸºæœ¬è¿è¡Œå‚æ•°**ï¼š
- `num_workers`ï¼šå¹¶è¡Œçº¿ç¨‹æ•°
- `num_gpus`ï¼šGPUæ•°é‡

**prompt_flow**ï¼ˆPrompt-Cloneæ¨¡å¼é…ç½®ï¼‰ï¼š
- `root_dir`ï¼šæ ¹ç›®å½•ï¼ˆåŒ…å«å­ç›®å½•å’ŒJSONæ–‡ä»¶ï¼‰
- `results_dir`ï¼šç»“æœè¾“å‡ºç›®å½•
- `logs_dir`ï¼šæ—¥å¿—è¾“å‡ºç›®å½•

**debug**ï¼ˆè°ƒè¯•æ¨¡å¼é…ç½®ï¼‰ï¼š
- `enabled`ï¼šæ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
- `samples`ï¼šè°ƒè¯•é‡‡æ ·æ•°é‡
- `dir`ï¼šè°ƒè¯•è¾“å‡ºç›®å½•

**vad**ï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹å‚æ•°ï¼‰ï¼š
- `frame_ms`ï¼šå¸§é•¿ï¼ˆæ¯«ç§’ï¼‰
- `min_speech_ms`ï¼šæœ€çŸ­è¯­éŸ³æ®µï¼ˆæ¯«ç§’ï¼‰
- `max_silence_ms`ï¼šæœ€é•¿é™éŸ³å¡«è¡¥ï¼ˆæ¯«ç§’ï¼‰

#### æ³¨æ„äº‹é¡¹

- å‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶
- è·¯å¾„å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„
- Debugæ¨¡å¼ä¼šè¦†ç›–æŸäº›å‚æ•°ï¼ˆå¦‚å¼ºåˆ¶å•è¿›ç¨‹ï¼‰

---

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ¿€æ´»condaç¯å¢ƒ
conda activate SpeakerIdentify

# ç¡®è®¤ä¾èµ–å·²å®‰è£…
pip install torch torchaudio tqdm numpy soundfile librosa matplotlib
```

#### 2. å¿«é€Ÿæµ‹è¯•ï¼ˆ10ä¸ªæ ·æœ¬ï¼‰

```bash
cd /root/code/github_repos/DataFilter/tts_speech_voiceprint_filter_old
./test_debug_mode.sh
```

é¢„æœŸç»“æœï¼š
- âœ… æˆåŠŸå¤„ç†10ä¸ªæ ·æœ¬
- âœ… ç”Ÿæˆç»“æœJSON
- âœ… ç”ŸæˆVADå¯è§†åŒ–å›¾
- âœ… æ— MagicMocké”™è¯¯

#### 3. Debugæ¨¡å¼æµ‹è¯•ï¼ˆ100ä¸ªæ ·æœ¬ï¼‰

```bash
./run_voiceprint_filter.sh \
  --debug \
  --debug_samples 100 \
  --verbose
```

#### 4. ç”Ÿäº§è¿è¡Œï¼ˆå®Œæ•´æ•°æ®é›†ï¼‰

```bash
./run_voiceprint_filter.sh \
  --prompt_root /root/group-shared/voiceprint/share/voiceclone_child_20250804 \
  --threshold 0.9 \
  --num_workers 8 \
  --num_gpus 8 \
  --verbose
```

### é«˜çº§ç”¨æ³•

#### è‡ªå®šä¹‰VADå‚æ•°

```bash
./run_voiceprint_filter.sh \
  --vad_frame_ms 20 \
  --vad_min_speech_ms 200 \
  --vad_max_silence_ms 300 \
  --verbose
```

#### æŒ‡å®šè¾“å‡ºè·¯å¾„

```bash
./run_voiceprint_filter.sh \
  --output /path/to/my_results.json \
  --prompt_results_dir /path/to/results \
  --prompt_logs_dir /path/to/logs \
  --verbose
```

#### ä½¿ç”¨è‡ªå®šä¹‰wav.scp

```bash
./run_voiceprint_filter.sh \
  --wav_scp /path/to/custom1.scp \
  --wav_scp /path/to/custom2.scp \
  --verbose
```

#### Pythonç›´æ¥è°ƒç”¨

```bash
python3 compute_similarity_prompts.py \
  --root_dir /path/to/root \
  --threshold 0.9 \
  --model_dir /path/to/model \
  --num_gpus 4 \
  --output /path/to/output.json \
  --verbose
```

---

## è¾“å‡ºè¯´æ˜

### è¾“å‡ºæ–‡ä»¶

è¿è¡Œåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

1. **ç»“æœJSONæ–‡ä»¶**ï¼ˆä¸»è¦è¾“å‡ºï¼‰
   - è·¯å¾„ï¼š`<results_dir>/tts_prompt_clone_similarity_<timestamp>.json`
   - åŒ…å«ï¼šç»Ÿè®¡ä¿¡æ¯ã€æ¯å¯¹éŸ³é¢‘çš„è¯¦ç»†ç»“æœ

2. **ç­›é™¤åˆ—è¡¨æ–‡ä»¶**
   - è·¯å¾„ï¼š`<results_dir>/tts_prompt_clone_similarity_<timestamp>_filtered_list.txt`
   - åŒ…å«ï¼šæ‰€æœ‰è¢«ç­›é™¤ï¼ˆç›¸ä¼¼åº¦ä½äºé˜ˆå€¼ï¼‰çš„cloneéŸ³é¢‘è·¯å¾„

3. **VADå¯è§†åŒ–å›¾**ï¼ˆä»…Debugæ¨¡å¼ï¼‰
   - è·¯å¾„ï¼š`<debug_dir>/<prompt_id>__<voiceprint_id>__<uid>_src.png`
   - è·¯å¾„ï¼š`<debug_dir>/<prompt_id>__<voiceprint_id>__<uid>_tts.png`
   - å†…å®¹ï¼šæ³¢å½¢+VADæ©ç å åŠ å›¾

### ç»“æœJSONç»“æ„

```json
{
  "metadata": {
    "timestamp": "2025-11-12T14:30:25",
    "threshold": 0.9,
    "model_dir": "/path/to/samresnet100",
    "num_gpus": 8,
    "num_workers": 8,
    "vad_config": {
      "frame_ms": 16,
      "min_speech_ms": 160,
      "max_silence_ms": 200
    }
  },
  "statistics": {
    "total_pairs": 10000,
    "processed_pairs": 9850,
    "failed_pairs": 150,
    "passed_pairs": 8900,
    "filtered_pairs": 950,
    "pass_rate": 0.903,
    "filter_rate": 0.097,
    "similarity_stats": {
      "mean": 0.8523,
      "median": 0.8751,
      "std": 0.1234,
      "min": 0.3421,
      "max": 0.9876
    },
    "processing_time_seconds": 1234.56
  },
  "filter_results": [
    {
      "voiceprint_id": "voiceprint_20250804_1800861",
      "prompt_id": "speechocean762_test_050170001",
      "prompt_audio": "/path/to/prompt.wav",
      "clone_audio": "/path/to/clone.wav",
      "similarity": 0.9234,
      "pass": true,
      "success": true,
      "vad": {
        "src_duration_sec": 3.45,
        "src_speech_duration_sec": 2.87,
        "src_speech_ratio": 0.832,
        "src_segments": [[0.16, 3.03]],
        "tts_duration_sec": 3.21,
        "tts_speech_duration_sec": 2.98,
        "tts_speech_ratio": 0.928,
        "tts_segments": [[0.08, 3.06]]
      },
      "error_message": null,
      "json_file": "voiceclone_20250804_001.json",
      "json_subdir": "voiceclone_20250804_001/"
    },
    {
      "voiceprint_id": "voiceprint_20250804_1800862",
      "prompt_id": "speechocean762_test_050170002",
      "prompt_audio": "/path/to/prompt2.wav",
      "clone_audio": "/path/to/clone2.wav",
      "similarity": 0.6543,
      "pass": false,
      "success": true,
      "vad": {...},
      "error_message": null,
      "json_file": "voiceclone_20250804_002.json",
      "json_subdir": "voiceclone_20250804_002/"
    },
    {
      "voiceprint_id": "voiceprint_20250804_1800863",
      "prompt_id": "speechocean762_test_050170003",
      "prompt_audio": null,
      "clone_audio": "/path/to/clone3.wav",
      "similarity": -1.0,
      "pass": false,
      "success": false,
      "vad": null,
      "error_message": "æ‰¾ä¸åˆ°promptéŸ³é¢‘",
      "json_file": "voiceclone_20250804_003.json",
      "json_subdir": "voiceclone_20250804_003/"
    }
  ]
}
```

### å­—æ®µè¯´æ˜

#### metadataï¼ˆå…ƒæ•°æ®ï¼‰
- `timestamp`ï¼šå¤„ç†æ—¶é—´æˆ³
- `threshold`ï¼šä½¿ç”¨çš„ç›¸ä¼¼åº¦é˜ˆå€¼
- `model_dir`ï¼šæ¨¡å‹ç›®å½•
- `num_gpus`ï¼šGPUæ•°é‡
- `vad_config`ï¼šVADé…ç½®å‚æ•°

#### statisticsï¼ˆç»Ÿè®¡ä¿¡æ¯ï¼‰
- `total_pairs`ï¼šæ€»é…å¯¹æ•°
- `processed_pairs`ï¼šæˆåŠŸå¤„ç†çš„é…å¯¹æ•°
- `failed_pairs`ï¼šå¤„ç†å¤±è´¥çš„é…å¯¹æ•°
- `passed_pairs`ï¼šé€šè¿‡é˜ˆå€¼çš„é…å¯¹æ•°
- `filtered_pairs`ï¼šè¢«ç­›é™¤çš„é…å¯¹æ•°
- `pass_rate`ï¼šé€šè¿‡ç‡
- `filter_rate`ï¼šç­›é™¤ç‡
- `similarity_stats`ï¼šç›¸ä¼¼åº¦ç»Ÿè®¡ï¼ˆå‡å€¼ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®ã€æœ€å¤§æœ€å°å€¼ï¼‰
- `processing_time_seconds`ï¼šå¤„ç†è€—æ—¶

#### filter_resultsï¼ˆè¯¦ç»†ç»“æœï¼‰

æ¯ä¸ªæ¡ç›®åŒ…å«ï¼š
- `voiceprint_id`ï¼šå£°çº¹IDï¼ˆclone_idï¼‰
- `prompt_id`ï¼šæç¤ºéŸ³é¢‘ID
- `prompt_audio`ï¼šæç¤ºéŸ³é¢‘è·¯å¾„
- `clone_audio`ï¼šå…‹éš†éŸ³é¢‘è·¯å¾„
- `similarity`ï¼šç›¸ä¼¼åº¦ï¼ˆ-1.0è¡¨ç¤ºå¤±è´¥ï¼‰
- `pass`ï¼šæ˜¯å¦é€šè¿‡é˜ˆå€¼
- `success`ï¼šæ˜¯å¦æˆåŠŸå¤„ç†
- `vad`ï¼šVADè¯¦ç»†ä¿¡æ¯
  - `src_duration_sec`ï¼šæºéŸ³é¢‘æ€»æ—¶é•¿
  - `src_speech_duration_sec`ï¼šæºéŸ³é¢‘æœ‰æ•ˆè¯­éŸ³æ—¶é•¿
  - `src_speech_ratio`ï¼šæºéŸ³é¢‘è¯­éŸ³å æ¯”
  - `src_segments`ï¼šæºéŸ³é¢‘è¯­éŸ³æ®µæ—¶é—´åŒºé—´
  - `tts_*`ï¼šTTSéŸ³é¢‘çš„å¯¹åº”ä¿¡æ¯
- `error_message`ï¼šé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
- `json_file`ï¼šæ¥æºJSONæ–‡ä»¶
- `json_subdir`ï¼šæ¥æºå­ç›®å½•

### ç­›é™¤åˆ—è¡¨æ–‡ä»¶

æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªè¢«ç­›é™¤çš„cloneéŸ³é¢‘è·¯å¾„

```
/path/to/clone1.wav
/path/to/clone2.wav
/path/to/clone3.wav
...
```

ç”¨é€”ï¼š
- æ–¹ä¾¿åç»­æ‰¹é‡åˆ é™¤æˆ–ç§»åŠ¨
- å¯ç”¨äºæ•°æ®é›†æ¸…ç†è„šæœ¬

### VADå¯è§†åŒ–å›¾

**æ–‡ä»¶å‘½å**ï¼š
- `<prompt_id>__<voiceprint_id>__<uid>_src.png`ï¼šæºéŸ³é¢‘ï¼ˆpromptï¼‰
- `<prompt_id>__<voiceprint_id>__<uid>_tts.png`ï¼šTTSéŸ³é¢‘ï¼ˆcloneï¼‰

**å›¾åƒå†…å®¹**ï¼š
- è“è‰²æ³¢å½¢ï¼šéŸ³é¢‘æ³¢å½¢
- ç»¿è‰²åŒºåŸŸï¼šVADæ£€æµ‹çš„æœ‰æ•ˆè¯­éŸ³æ®µ
- æ ‡é¢˜ï¼šåŒ…å«ç›¸ä¼¼åº¦ã€é€šè¿‡çŠ¶æ€ã€VADç»Ÿè®¡ä¿¡æ¯

**ç”¨é€”**ï¼š
- è°ƒè¯•VADå‚æ•°
- æ£€æŸ¥éŸ³é¢‘è´¨é‡
- åˆ†æç­›é™¤åŸå› 

---

## å¸¸è§é—®é¢˜

### Q1: MagicMocké”™è¯¯

**é—®é¢˜**ï¼šè¿è¡Œæ—¶å‡ºç° `'<' not supported between instances of 'MagicMock' and 'int'`

**åŸå› **ï¼štorioæ‰©å±•ä¸MagicMockå†²çª

**è§£å†³**ï¼šå·²ä¿®å¤ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„`multilingual_inference.py`

---

### Q2: å†…å­˜ä¸è¶³

**é—®é¢˜**ï¼šè¿è¡Œæ—¶å†…å­˜å ç”¨è¿‡é«˜ï¼Œå¯¼è‡´OOM

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å‡å°‘GPUæ•°é‡ï¼š`--num_gpus 2`
2. å‡å°‘å¹¶è¡Œçº¿ç¨‹æ•°ï¼š`--num_workers 2`
3. ä½¿ç”¨Debugæ¨¡å¼æµ‹è¯•å°æ‰¹é‡ï¼š`--debug --debug_samples 100`
4. åˆ†æ‰¹å¤„ç†æ•°æ®é›†

---

### Q3: GPUåˆ©ç”¨ç‡ä½

**é—®é¢˜**ï¼šGPUåˆ©ç”¨ç‡å¾ˆä½ï¼Œå¤„ç†é€Ÿåº¦æ…¢

**åŸå› **ï¼š
- embeddingæå–æ˜¯CPUå¯†é›†å‹æ“ä½œ
- VADæ£€æµ‹åœ¨CPUä¸Šè¿›è¡Œ
- å®é™…GPUä½¿ç”¨ä»…åœ¨embeddingæå–çš„å‰å‘ä¼ æ’­é˜¶æ®µ

**ä¼˜åŒ–å»ºè®®**ï¼š
1. å¢åŠ num_workersï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPU
2. ä½¿ç”¨æ›´å¿«çš„å­˜å‚¨ï¼ˆSSDï¼‰
3. å…³é—­VADå¯è§†åŒ–ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰

---

### Q4: æ‰¾ä¸åˆ°éŸ³é¢‘æ–‡ä»¶

**é—®é¢˜**ï¼šå¾ˆå¤šé…å¯¹æ˜¾ç¤º"æ‰¾ä¸åˆ°promptéŸ³é¢‘"æˆ–"æ‰¾ä¸åˆ°cloneéŸ³é¢‘"

**åŸå› **ï¼š
- JSONä¸­çš„IDä¸å®é™…æ–‡ä»¶åä¸åŒ¹é…
- æ–‡ä»¶ä¸åœ¨é¢„æœŸçš„å­ç›®å½•ä¸­
- éŸ³é¢‘æ–‡ä»¶æ‰©å±•åä¸æ”¯æŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥JSONæ–‡ä»¶çš„prompt_idå’Œclone_idæ ¼å¼
2. æ£€æŸ¥å­ç›®å½•ç»“æ„æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ‰©å±•åæ˜¯å¦åœ¨æ”¯æŒåˆ—è¡¨ä¸­
4. ä½¿ç”¨`--wav_scp`å‚æ•°æ·»åŠ é¢å¤–çš„éŸ³é¢‘ç´¢å¼•

---

### Q5: VADå‚æ•°å¦‚ä½•è°ƒæ•´

**é—®é¢˜**ï¼šVADæ£€æµ‹ä¸å‡†ç¡®ï¼Œæœ‰æ•ˆè¯­éŸ³æ®µå¤ªå¤šæˆ–å¤ªå°‘

**è°ƒæ•´å»ºè®®**ï¼š

**å¦‚æœæ¼æ£€ï¼ˆæœ‰æ•ˆè¯­éŸ³è¢«å½“ä½œé™éŸ³ï¼‰**ï¼š
- å‡å°`vad_min_speech_ms`ï¼ˆå¦‚100msï¼‰
- å¢å¤§`vad_max_silence_ms`ï¼ˆå¦‚300msï¼‰

**å¦‚æœè¯¯æ£€ï¼ˆé™éŸ³è¢«å½“ä½œè¯­éŸ³ï¼‰**ï¼š
- å¢å¤§`vad_min_speech_ms`ï¼ˆå¦‚200msï¼‰
- å‡å°`vad_max_silence_ms`ï¼ˆå¦‚100msï¼‰

**é€šç”¨å»ºè®®**ï¼š
- ä½¿ç”¨Debugæ¨¡å¼ç”ŸæˆVADå›¾ï¼Œè§‚å¯Ÿæ•ˆæœ
- æ ¹æ®å®é™…éŸ³é¢‘ç‰¹ç‚¹è°ƒæ•´
- ä¸€èˆ¬é»˜è®¤å‚æ•°é€‚ç”¨äºå¤§å¤šæ•°æƒ…å†µ

---

### Q6: ç›¸ä¼¼åº¦é˜ˆå€¼å¦‚ä½•è®¾ç½®

**é—®é¢˜**ï¼šä¸çŸ¥é“thresholdåº”è¯¥è®¾ç½®ä¸ºå¤šå°‘

**å»ºè®®**ï¼š

**ä¿å®ˆç­–ç•¥ï¼ˆé«˜è´¨é‡è¦æ±‚ï¼‰**ï¼š
- threshold = 0.90-0.95
- é€‚åˆï¼šè®­ç»ƒæ•°æ®è¦æ±‚é«˜è´¨é‡
- ç¼ºç‚¹ï¼šå¯èƒ½ç­›é™¤è¿‡å¤š

**å¹³è¡¡ç­–ç•¥ï¼ˆæ¨èï¼‰**ï¼š
- threshold = 0.75-0.85
- é€‚åˆï¼šä¸€èˆ¬TTSæ•°æ®æ¸…æ´—
- ä¼˜ç‚¹ï¼šå¹³è¡¡è´¨é‡ä¸æ•°é‡

**å®½æ¾ç­–ç•¥ï¼ˆä¿ç•™æ›´å¤šæ•°æ®ï¼‰**ï¼š
- threshold = 0.60-0.70
- é€‚åˆï¼šæ•°æ®é‡æœ‰é™ï¼Œéœ€è¦ä¿ç•™æ›´å¤šæ ·æœ¬
- ç¼ºç‚¹ï¼šå¯èƒ½ä¿ç•™éƒ¨åˆ†ä½è´¨é‡æ ·æœ¬

**å»ºè®®æµç¨‹**ï¼š
1. å…ˆç”¨Debugæ¨¡å¼è·‘100-1000ä¸ªæ ·æœ¬
2. æŸ¥çœ‹ç›¸ä¼¼åº¦åˆ†å¸ƒï¼ˆstatistics.similarity_statsï¼‰
3. æ ¹æ®åˆ†å¸ƒå’Œéœ€æ±‚è®¾ç½®é˜ˆå€¼
4. éšæœºæŠ½å–å‡ ä¸ªè¾¹ç•Œæ ·æœ¬å¬å¬æ•ˆæœ
5. è°ƒæ•´é˜ˆå€¼åé‡æ–°è¿è¡Œ

---

### Q7: Debugæ¨¡å¼é€Ÿåº¦å¤ªæ…¢

**é—®é¢˜**ï¼šDebugæ¨¡å¼å¤„ç†100ä¸ªæ ·æœ¬éœ€è¦å¾ˆé•¿æ—¶é—´

**åŸå› **ï¼šDebugæ¨¡å¼é»˜è®¤ä½¿ç”¨CPUï¼Œä¸”ä¿å­˜VADå›¾è€—æ—¶

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨GPUï¼ˆå¦‚æœç¨³å®šï¼‰ï¼šä¿®æ”¹ä»£ç ä¸­çš„`device='cpu'`ä¸º`device='cuda'`
2. å‡å°‘é‡‡æ ·æ•°ï¼š`--debug_samples 10`
3. è·³è¿‡VADå›¾ï¼ˆä¿®æ”¹ä»£ç ï¼Œæ³¨é‡Š`_save_vad_plot`è°ƒç”¨ï¼‰

---

### Q8: å¦‚ä½•å¹¶è¡Œå¤„ç†å¤šä¸ªæ•°æ®é›†

**é—®é¢˜**ï¼šæœ‰å¤šä¸ªä¸åŒçš„æ•°æ®é›†éœ€è¦å¤„ç†

**æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šé¡ºåºå¤„ç†**
```bash
./run_voiceprint_filter.sh --prompt_root /path/to/dataset1 --verbose
./run_voiceprint_filter.sh --prompt_root /path/to/dataset2 --verbose
./run_voiceprint_filter.sh --prompt_root /path/to/dataset3 --verbose
```

**æ–¹æ¡ˆ2ï¼šå¹¶è¡Œå¤„ç†ï¼ˆå¤šæœºå™¨æˆ–å¤šGPUç»„ï¼‰**
```bash
# æœºå™¨1ï¼ˆGPU 0-3ï¼‰
CUDA_VISIBLE_DEVICES=0,1,2,3 ./run_voiceprint_filter.sh --prompt_root /path/to/dataset1 --num_gpus 4 &

# æœºå™¨2ï¼ˆGPU 4-7ï¼‰
CUDA_VISIBLE_DEVICES=4,5,6,7 ./run_voiceprint_filter.sh --prompt_root /path/to/dataset2 --num_gpus 4 &

wait
```

---

### Q9: å¦‚ä½•æŸ¥çœ‹è¿›åº¦

**é—®é¢˜**ï¼šå¤„ç†å¤§æ•°æ®é›†æ—¶ä¸çŸ¥é“è¿›åº¦

**æ–¹æ¡ˆ**ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   - ä½¿ç”¨`--verbose`å‚æ•°
   - æ—¥å¿—ä¼šæ˜¾ç¤ºå¤„ç†è¿›åº¦

2. **ç›‘æ§ç»“æœæ–‡ä»¶**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹å¤„ç†æ•°é‡
watch -n 5 'jq ".statistics.processed_pairs" results/latest.json'
```

3. **ä¼°ç®—æ—¶é—´**ï¼š
   - å…ˆç”¨Debugæ¨¡å¼è·‘100ä¸ªæ ·æœ¬ï¼Œè®°å½•è€—æ—¶
   - æ ¹æ®æ€»æ ·æœ¬æ•°ä¼°ç®—æ€»æ—¶é—´

---

### Q10: å¦‚ä½•éªŒè¯ç»“æœè´¨é‡

**é—®é¢˜**ï¼šæƒ³éªŒè¯ç­›é€‰ç»“æœæ˜¯å¦å‡†ç¡®

**éªŒè¯æ–¹æ³•**ï¼š

1. **éšæœºæŠ½æ ·å¬æµ‹**ï¼š
```bash
# æå–é«˜ç›¸ä¼¼åº¦æ ·æœ¬
jq '.filter_results[] | select(.similarity > 0.95) | .clone_audio' results.json | shuf | head -10

# æå–ä½ç›¸ä¼¼åº¦æ ·æœ¬
jq '.filter_results[] | select(.similarity < 0.70) | .clone_audio' results.json | shuf | head -10

# æå–è¾¹ç•Œæ ·æœ¬ï¼ˆé˜ˆå€¼é™„è¿‘ï¼‰
jq '.filter_results[] | select(.similarity > 0.88 and .similarity < 0.92) | .clone_audio' results.json | shuf | head -10
```

2. **æŸ¥çœ‹VADå›¾**ï¼š
   - ä½¿ç”¨Debugæ¨¡å¼ç”Ÿæˆéƒ¨åˆ†æ ·æœ¬çš„VADå›¾
   - æ£€æŸ¥VADæ˜¯å¦å‡†ç¡®
   - æ£€æŸ¥éŸ³é¢‘è´¨é‡

3. **ç»Ÿè®¡åˆ†æ**ï¼š
```bash
# æŸ¥çœ‹ç›¸ä¼¼åº¦åˆ†å¸ƒ
jq '.statistics.similarity_stats' results.json

# æŸ¥çœ‹é€šè¿‡ç‡
jq '.statistics.pass_rate' results.json

# æŸ¥çœ‹å¤±è´¥åŸå› åˆ†å¸ƒ
jq '[.filter_results[] | select(.success == false) | .error_message] | group_by(.) | map({error: .[0], count: length})' results.json
```

---

## æŠ€æœ¯ç»†èŠ‚

### å£°çº¹è¯†åˆ«åŸç†

**WeSpeakeræ¨¡å‹**ï¼š
- æ¶æ„ï¼šResNet100
- è¾“å…¥ï¼š16kHzå•å£°é“éŸ³é¢‘
- è¾“å‡ºï¼š192ç»´embeddingå‘é‡
- è®­ç»ƒï¼šå¤šè¯­è¨€ï¼ˆä¸­è‹±æ–‡ç­‰ï¼‰è¯´è¯äººè¯†åˆ«ä»»åŠ¡

**ç›¸ä¼¼åº¦è®¡ç®—**ï¼š
- æ–¹æ³•ï¼šä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰
- å…¬å¼ï¼š`similarity = (emb1 Â· emb2) / (||emb1|| Ã— ||emb2||)`
- èŒƒå›´ï¼š[-1, 1]ï¼Œå®é™…é€šå¸¸åœ¨[0, 1]
- è§£é‡Šï¼š
  - æ¥è¿‘1ï¼šåŒä¸€è¯´è¯äºº
  - æ¥è¿‘0ï¼šä¸åŒè¯´è¯äºº
  - è´Ÿå€¼ï¼šæå…¶ä¸åŒï¼ˆç½•è§ï¼‰

### VADï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼‰

**TEN VAD**ï¼š
- åŸºäºæ·±åº¦å­¦ä¹ çš„VADæ¨¡å‹
- å®æ—¶æ€§å¥½ï¼Œå‡†ç¡®ç‡é«˜
- é€‚åˆå¤šè¯­è¨€åœºæ™¯

**å·¥ä½œåŸç†**ï¼š
1. å°†éŸ³é¢‘åˆ†å¸§ï¼ˆé»˜è®¤16msï¼‰
2. å¯¹æ¯å¸§è¿›è¡Œè¯­éŸ³/éè¯­éŸ³åˆ†ç±»
3. åå¤„ç†ï¼šåˆå¹¶çŸ­è¯­éŸ³æ®µï¼Œå¡«è¡¥çŸ­é™éŸ³æ®µ
4. è¾“å‡ºï¼šå¸ƒå°”æ©ç ï¼ˆTrue=è¯­éŸ³å¸§ï¼‰

**å‚æ•°å½±å“**ï¼š
- `frame_ms`ï¼šå¸§é•¿ï¼Œè¶Šå°ç²¾åº¦è¶Šé«˜ä½†è®¡ç®—é‡è¶Šå¤§
- `min_speech_ms`ï¼šçŸ­äºæ­¤å€¼çš„è¯­éŸ³æ®µä¼šè¢«å¿½ç•¥
- `max_silence_ms`ï¼šçŸ­äºæ­¤å€¼çš„é™éŸ³æ®µä¼šè¢«å¡«è¡¥

**åº”ç”¨åœºæ™¯**ï¼š
- å»é™¤éŸ³é¢‘ä¸­çš„é™éŸ³æ®µ
- æå–æœ‰æ•ˆè¯­éŸ³è¿›è¡Œå£°çº¹è¯†åˆ«
- æé«˜ç›¸ä¼¼åº¦è®¡ç®—çš„å‡†ç¡®æ€§

### å¤šGPUå¹¶è¡Œç­–ç•¥

**ç­–ç•¥**ï¼šå¤šè¿›ç¨‹å¹¶è¡Œï¼Œæ¯ä¸ªè¿›ç¨‹ç‹¬å ä¸€ä¸ªGPU

**å®ç°**ï¼š
1. å°†é…å¯¹åˆ—è¡¨åˆ†æˆNä»½ï¼ˆN=num_gpusï¼‰
2. ä¸ºæ¯ä¸ªGPUå¯åŠ¨ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹
3. æ¯ä¸ªè¿›ç¨‹ï¼š
   - è®¾ç½®`CUDA_VISIBLE_DEVICES`
   - åŠ è½½æ¨¡å‹åˆ°æŒ‡å®šGPU
   - å¤„ç†åˆ†é…çš„é…å¯¹å­é›†
4. ä¸»è¿›ç¨‹æ”¶é›†æ‰€æœ‰å­è¿›ç¨‹çš„ç»“æœ

**ä¼˜ç‚¹**ï¼š
- é¿å…GILé”ï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰
- æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹ï¼Œä¸ç›¸äº’å½±å“
- GPUåˆ©ç”¨ç‡é«˜

**ç¼ºç‚¹**ï¼š
- æ¯ä¸ªè¿›ç¨‹éœ€è¦ç‹¬ç«‹åŠ è½½æ¨¡å‹ï¼ˆå†…å­˜å¼€é”€ï¼‰
- è¿›ç¨‹é—´é€šä¿¡æœ‰ä¸€å®šå¼€é”€

### éŸ³é¢‘å¤„ç†æµç¨‹

**åŠ è½½éŸ³é¢‘**ï¼š
- ä¼˜å…ˆä½¿ç”¨soundfileï¼ˆé€Ÿåº¦å¿«ï¼‰
- å¤±è´¥åˆ™ä½¿ç”¨librosaï¼ˆå…¼å®¹æ€§å¥½ï¼‰
- è‡ªåŠ¨å¤„ç†å¤šå£°é“ï¼ˆå–ç¬¬ä¸€å£°é“æˆ–å¹³å‡ï¼‰

**é‡é‡‡æ ·**ï¼š
- ç›®æ ‡ï¼š16kHzï¼ˆWeSpeakerè¦æ±‚ï¼‰
- æ–¹æ³•ï¼šlibrosa.resampleï¼ˆé«˜è´¨é‡é‡é‡‡æ ·ï¼‰

**VADå¤„ç†**ï¼š
- åº”ç”¨TEN VADè·å–æ©ç 
- æ ¹æ®æ©ç æå–æœ‰æ•ˆè¯­éŸ³å¸§
- æ‹¼æ¥æˆè¿ç»­çš„è¯­éŸ³æ®µ

**Embeddingæå–**ï¼š
- å°†è¯­éŸ³æ•°ç»„è½¬ä¸ºtorch tensor
- è°ƒç”¨WeSpeakeræ¨¡å‹
- è·å–embeddingå‘é‡

**ç›¸ä¼¼åº¦è®¡ç®—**ï¼š
- è®¡ç®—ä¸¤ä¸ªembeddingçš„ä½™å¼¦ç›¸ä¼¼åº¦
- è¿”å›0-1ä¹‹é—´çš„å€¼

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

**1. æ‰¹å¤„ç†ä¼˜åŒ–**ï¼š
- ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰JSONæ–‡ä»¶
- æ„å»ºå…¨å±€éŸ³é¢‘ç´¢å¼•ï¼Œé¿å…é‡å¤æ‰«æ

**2. ç¼“å­˜ä¼˜åŒ–**ï¼š
- å¯¹äºé‡å¤å‡ºç°çš„promptéŸ³é¢‘ï¼Œå¯ä»¥ç¼“å­˜embedding
- å‡å°‘é‡å¤è®¡ç®—

**3. I/Oä¼˜åŒ–**ï¼š
- ä½¿ç”¨SSDå­˜å‚¨éŸ³é¢‘æ–‡ä»¶
- å‡å°‘å°æ–‡ä»¶è¯»å†™

**4. å¹¶è¡Œä¼˜åŒ–**ï¼š
- æ ¹æ®CPUæ ¸æ•°è°ƒæ•´num_workers
- æ ¹æ®GPUå†…å­˜è°ƒæ•´num_gpus
- å¹³è¡¡CPUå’ŒGPUè´Ÿè½½

**5. å†…å­˜ä¼˜åŒ–**ï¼š
- ä¸ç¼“å­˜åŸå§‹éŸ³é¢‘æ•°æ®
- åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„tensor
- ä½¿ç”¨float32è€Œéfloat64

### é”™è¯¯å¤„ç†æœºåˆ¶

**éŸ³é¢‘åŠ è½½é”™è¯¯**ï¼š
- æ•è·å¼‚å¸¸ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯
- æ ‡è®°ä¸ºå¤±è´¥ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€å¯¹
- ä¸ç»ˆæ­¢æ•´ä¸ªæµç¨‹

**æ¨¡å‹æ¨ç†é”™è¯¯**ï¼š
- æ•è·å¼‚å¸¸ï¼Œè®°å½•è¯¦ç»†é”™è¯¯
- è¿”å›similarity=-1.0è¡¨ç¤ºå¤±è´¥
- è®°å½•åˆ°ç»“æœJSONä¸­

**æ–‡ä»¶æŸ¥æ‰¾é”™è¯¯**ï¼š
- æ‰¾ä¸åˆ°æ–‡ä»¶æ—¶è·³è¿‡è¯¥é…å¯¹
- è®°å½•å…·ä½“å“ªä¸ªæ–‡ä»¶æ‰¾ä¸åˆ°
- ç»§ç»­å¤„ç†å…¶ä»–é…å¯¹

**åŸåˆ™**ï¼š
- å°½é‡ä¸å› ä¸ªåˆ«æ ·æœ¬å¤±è´¥è€Œç»ˆæ­¢æ•´ä¸ªæµç¨‹
- è¯¦ç»†è®°å½•æ‰€æœ‰é”™è¯¯ä¿¡æ¯
- æä¾›è¶³å¤Ÿçš„è°ƒè¯•ä¿¡æ¯

### æ•°æ®ç»„ç»‡æœ€ä½³å®è·µ

**ç›®å½•ç»“æ„å»ºè®®**ï¼š
```
root_dir/
â”œâ”€â”€ subdir_001/
â”‚   â”œâ”€â”€ prompt_audio1.wav
â”‚   â”œâ”€â”€ clone_audio1.wav
â”‚   â””â”€â”€ ...
â”œâ”€â”€ subdir_002/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ subdir_001.json    # å¯¹åº”subdir_001/
â”œâ”€â”€ subdir_002.json    # å¯¹åº”subdir_002/
â””â”€â”€ ...
```

**JSONæ ¼å¼å»ºè®®**ï¼š
```json
{
  "dataset_name": "voiceclone_child_20250804",
  "entries": [
    {
      "prompt_id": "unique_prompt_id_001",
      "clone_id": "unique_clone_id_001",
      "prompt_text": "è¿™æ˜¯æç¤ºæ–‡æœ¬",
      "speaker": "speaker_001",
      ...
    },
    ...
  ]
}
```

**æ–‡ä»¶å‘½åå»ºè®®**ï¼š
- ä½¿ç”¨å”¯ä¸€IDä½œä¸ºæ–‡ä»¶å
- é¿å…ç‰¹æ®Šå­—ç¬¦å’Œç©ºæ ¼
- ä¿æŒä¸€è‡´çš„å‘½åè§„èŒƒ

---

## é™„å½•

### A. ä¾èµ–åˆ—è¡¨

```
# æ ¸å¿ƒä¾èµ–
torch >= 2.0.0
torchaudio >= 2.0.0
numpy >= 1.20.0
soundfile >= 0.11.0
librosa >= 0.9.0

# WeSpeaker
wespeaker >= 1.0.0

# VAD
ten-vad

# å¯è§†åŒ–
matplotlib >= 3.5.0

# å·¥å…·
tqdm >= 4.60.0
pyyaml >= 5.4.0
```

### B. å‚è€ƒæ–‡æ¡£

- [WeSpeakerå®˜æ–¹æ–‡æ¡£](https://github.com/wenet-e2e/wespeaker)
- [TEN VADæ–‡æ¡£](https://github.com/tenstorrent/ten-vad)
- [Librosaæ–‡æ¡£](https://librosa.org/)

### C. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# å¿«é€Ÿæµ‹è¯•
./test_debug_mode.sh

# Debugæ¨¡å¼ï¼ˆ100æ ·æœ¬ï¼‰
./run_voiceprint_filter.sh --debug --debug_samples 100 --verbose

# ç”Ÿäº§è¿è¡Œ
./run_voiceprint_filter.sh --threshold 0.9 --num_gpus 8 --verbose

# æŸ¥çœ‹ç»“æœç»Ÿè®¡
jq '.statistics' results/latest.json

# æå–ç­›é™¤åˆ—è¡¨
jq -r '.filter_results[] | select(.pass == false) | .clone_audio' results/latest.json

# ç»Ÿè®¡å¤±è´¥åŸå› 
jq '[.filter_results[] | select(.success == false) | .error_message] | group_by(.) | map({error: .[0], count: length})' results/latest.json
```

### D. ç‰ˆæœ¬å†å²

- **2025-11-12**ï¼šä¿®å¤MagicMocké”™è¯¯ï¼Œæ·»åŠ Debugæ¨¡å¼
- **2025-08-04**ï¼šåˆå§‹ç‰ˆæœ¬ï¼ŒPrompt-Cloneæ¨¡å¼

### E. ç»´æŠ¤å›¢é˜Ÿ

- AI Assistant

### F. è®¸å¯è¯

ï¼ˆæ ¹æ®é¡¹ç›®å®é™…æƒ…å†µå¡«å†™ï¼‰

---

## ç»“è¯­

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†TTSè¯­éŸ³å£°çº¹è¿‡æ»¤ç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ï¼Œä»æ•´ä½“æ¶æ„åˆ°å…·ä½“å®ç°ç»†èŠ‚ã€‚å¸Œæœ›èƒ½å¸®åŠ©ä½ å¿«é€Ÿç†è§£å’Œä½¿ç”¨æœ¬ç³»ç»Ÿã€‚

å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·å‚è€ƒï¼š
- `QUICK_START.md` - å¿«é€Ÿå¼€å§‹
- `DEBUG_MODE_README.md` - è°ƒè¯•æ¨¡å¼è¯¦è§£
- `CHANGELOG.md` - ä¿®æ”¹å†å²

ç¥ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰

